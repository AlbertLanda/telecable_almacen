{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Dashboard | Telecable</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --bg-body: #1e1e2e;
      --bg-sidebar: #181824;
      --bg-panel: #27293d;

      --primary-grad: linear-gradient(45deg, #FF512F 0%, #DD2476 100%);
      --primary-solid: #ff6b6b;

      --accent: #4facfe;
      --text-main: #ffffff;
      --text-muted: #9a9a9a;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Poppins', sans-serif;
      background-color: var(--bg-body);
      color: var(--text-main);
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    .sidebar {
      width: 260px;
      background-color: var(--bg-sidebar);
      padding: 20px;
      display: flex;
      flex-direction: column;
      border-right: 1px solid rgba(255,255,255,0.05);
      box-shadow: 5px 0 15px rgba(0,0,0,0.2);
      z-index: 10;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 50px;
      padding-bottom: 20px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .brand img { width: 40px; height: 40px; border-radius: 8px; object-fit: cover; }
    .brand span { font-size: 20px; font-weight: 700; color: white; letter-spacing: 1px; text-transform: uppercase; }

    .menu-btn {
      background: transparent;
      border: none;
      width: 100%;
      padding: 16px 20px;
      text-align: left;
      color: var(--text-muted);
      font-size: 14px;
      cursor: pointer;
      border-radius: 12px;
      display: flex;
      align-items: center;
      gap: 15px;
      transition: all 0.3s ease;
      margin-bottom: 8px;
      font-weight: 500;
      text-decoration: none;
    }
    .menu-btn i { font-size: 20px; }
    .menu-btn:hover { background: rgba(255, 255, 255, 0.05); color: white; padding-left: 25px; }
    .menu-btn.active { background: var(--primary-grad); color: white; box-shadow: 0 4px 15px rgba(221, 36, 118, 0.4); }

    .logout-btn { margin-top: auto; color: #ff4757; border: 1px solid rgba(255, 71, 87, 0.2); }
    .logout-btn:hover { background: rgba(255, 71, 87, 0.1); color: white; }

    .main-content {
      flex: 1;
      padding: 30px;
      overflow-y: auto;
      background-image: radial-gradient(rgba(255,255,255,0.03) 1px, transparent 1px);
      background-size: 30px 30px;
    }

    .header {
      margin-bottom: 35px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    .header h2 { font-weight: 600; font-size: 28px; }
    .header p { color: var(--text-muted); font-size: 14px; }

    .user-badge {
      background: var(--bg-panel);
      padding: 8px 15px;
      border-radius: 30px;
      display: flex;
      align-items: center;
      gap: 10px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .user-badge i { font-size: 20px; color: var(--primary-solid); }

    .section-view { display: none; animation: fadeIn 0.4s; }
    .section-view.active { display: block; }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 25px;
      margin-bottom: 30px;
    }

    .card {
      background: var(--bg-panel);
      padding: 25px;
      border-radius: 16px;
      position: relative;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      transition: transform 0.3s;
    }
    .card:hover { transform: translateY(-5px); }

    .kpi-icon {
      width: 50px;
      height: 50px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      margin-bottom: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    .card h3 { font-size: 32px; font-weight: 700; margin-bottom: 5px; color: white; }
    .card span { color: var(--text-muted); font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; }

    .charts-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; margin-bottom: 25px; }
    .chart-container {
      background: var(--bg-panel);
      padding: 25px;
      border-radius: 16px;
      height: 360px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .chart-full { grid-column: 1 / -1; }

    .table-container {
      background: var(--bg-panel);
      padding: 25px;
      border-radius: 16px;
      overflow-x: auto;
      margin-bottom: 25px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th { text-align: left; color: var(--primary-solid); padding: 15px; border-bottom: 2px solid rgba(255,255,255,0.05); font-size: 12px; text-transform: uppercase; font-weight: 600; }
    td { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 14px; color: #ddd; }
    tr:hover td { background: rgba(255,255,255,0.02); }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    @media (max-width: 900px){
      .kpi-grid{grid-template-columns:1fr;}
      .charts-grid{grid-template-columns:1fr;}
      .sidebar{width:220px;}
    }
  </style>
</head>

<body>
  <div class="sidebar">
    <div class="brand">
      <img src="{% static 'inventario/img/logo.png' %}" alt="Logo">
      <span>TELECABLE</span>
    </div>

    <button class="menu-btn active" data-tab="dashboard">
      <i class='bx bxs-dashboard'></i> Dashboard
    </button>
    <button class="menu-btn" data-tab="inventory">
      <i class='bx bxs-box'></i> Inventario
    </button>

    <a class="menu-btn logout-btn" href="{% url 'logout' %}">
      <i class='bx bx-log-out-circle'></i> Cerrar Sesi贸n
    </a>
  </div>

  <div class="main-content">
    <div class="header">
      <div>
        <h2 id="welcomeText">Resumen General</h2>
        <p>Sede: <b>{{ sede.nombre }}</b></p>
      </div>
      <div class="user-badge">
        <i class='bx bxs-user-circle'></i>
        <span>{{ request.user.username }}</span>
      </div>
    </div>

    <div id="dashboard" class="section-view active">
      <div class="kpi-grid">
        <div class="card">
          <div class="kpi-icon" style="background: rgba(255, 107, 107, 0.15); color: #ff6b6b;">
            <i class='bx bxs-wallet'></i>
          </div>
          <span>Valor del Inventario</span>
          <h3 id="kpiValue">S/ 0.00</h3>
        </div>

        <div class="card">
          <div class="kpi-icon" style="background: rgba(79, 172, 254, 0.15); color: #4facfe;">
            <i class='bx bxs-truck'></i>
          </div>
          <span>REQ Pendientes</span>
          <h3 id="kpiOrders">0</h3>
        </div>

        <div class="table-container">
          <h4 style="font-size:16px; margin-bottom:15px;">Ь REQ Pendientes (Acciones)</h4>

          {% if messages %}
            <div style="margin-bottom:12px;">
              {% for message in messages %}
                <p style="margin:6px 0;">{{ message }}</p>
              {% endfor %}
            </div>
          {% endif %}

          <table>
            <thead>
              <tr>
                <th>REQ</th>
                <th>Solicitante</th>
                <th>Fecha</th>
                <th>Estado</th>
                <th>Acci贸n</th>
              </tr>
            </thead>
            <tbody>
              {% for r in ult_reqs %}
                <tr>
                  <td>{{ r.numero|default:"(sin n煤mero)" }}</td>
                  <td>{{ r.responsable.username }}</td>
                  <td>{{ r.fecha|date:"Y-m-d H:i" }}</td>
                  <td>{{ r.get_estado_display }}</td>
                  <td>
                    <form method="post" action="{% url 'req_to_sal' r.id %}">
                      {% csrf_token %}
                      <button type="submit" style="
                        padding:10px 14px; border:none; border-radius:10px;
                        cursor:pointer; background:rgba(79,172,254,.2);
                        color:#fff; font-weight:600;
                      ">
                        Convertir a SAL
                      </button>
                    </form>
                  </td>
                </tr>
              {% empty %}
                <tr><td colspan="5" style="color:#9a9a9a;">No hay REQs pendientes.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>


        <div class="card">
          <div class="kpi-icon" style="background: rgba(255, 71, 87, 0.15); color: #ff4757;">
            <i class='bx bxs-bell-ring'></i>
          </div>
          <span>Alertas Stock Bajo</span>
          <h3 id="kpiLowStock">0</h3>
        </div>
      </div>

      <div class="charts-grid">
        <div class="chart-container chart-full">
          <h4 style="margin-bottom:20px; color:#fff;">Flujo de Movimientos (煤ltimos 60 min)</h4>
          <canvas id="lineChart"></canvas>
        </div>

        <div class="chart-container">
          <h4 style="margin-bottom:20px; color:#fff;">Top Productos (Stock)</h4>
          <canvas id="doughnutChart"></canvas>
        </div>

        <div class="chart-container">
          <h4 style="margin-bottom:20px; color:#fff;">Stock (Top 8)</h4>
          <canvas id="barChart"></canvas>
        </div>
      </div>
    </div>

    <div id="inventory" class="section-view">
      <div class="table-container">
        <h4 style="font-size:16px; margin-bottom:15px;"> Stock Actual Disponible</h4>
        <table id="stockTable">
          <thead><tr><th>C贸d</th><th>Producto</th><th>Cant</th><th>Estado</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="table-container">
        <h4 style="font-size:16px; margin-bottom:15px;">Ь REQ Pendientes (Sede)</h4>
        <table id="reqTable">
          <thead><tr><th>REQ</th><th>Solicitante</th><th>Fecha</th><th>Estado</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

  </div>

  <script>
    // Tabs
    document.querySelectorAll('.menu-btn[data-tab]').forEach(btn => {
      btn.addEventListener('click', () => {
        const tabId = btn.getAttribute('data-tab');

        document.querySelectorAll('.section-view').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.menu-btn[data-tab]').forEach(el => el.classList.remove('active'));

        document.getElementById(tabId).classList.add('active');
        btn.classList.add('active');
      });
    });

    const money = new Intl.NumberFormat('es-PE', { style: 'currency', currency: 'PEN' });

    let charts = {};
    let loading = false;

    function renderCharts(lineLabels, lineIn, lineOut, topNames, topQty) {
      if (charts.line) charts.line.destroy();
      if (charts.doughnut) charts.doughnut.destroy();
      if (charts.bar) charts.bar.destroy();

      // LINE
      const ctxLine = document.getElementById('lineChart').getContext('2d');
      charts.line = new Chart(ctxLine, {
        type: 'line',
        data: {
          labels: lineLabels,
          datasets: [
            { label: 'IN', data: lineIn, borderColor: '#4facfe', backgroundColor: 'rgba(79, 172, 254, 0.08)', tension: 0.35, fill: true, pointRadius: 0 },
            { label: 'OUT', data: lineOut, borderColor: '#ff6b6b', backgroundColor: 'rgba(255, 107, 107, 0.06)', tension: 0.35, fill: true, pointRadius: 0 }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { labels: { color: '#fff' } } },
          scales: {
            y: { grid: { color: '#3d3d5c' }, ticks: { color: '#ddd' } },
            x: { grid: { display: false }, ticks: { color: '#ddd', maxTicksLimit: 10 } }
          }
        }
      });

      // DOUGHNUT (colores fijos)
      const doughnutColors = ['#ff6b6b', '#4facfe', '#DD2476', '#FF512F', '#8e44ad'];
      const ctxD = document.getElementById('doughnutChart').getContext('2d');
      charts.doughnut = new Chart(ctxD, {
        type: 'doughnut',
        data: {
          labels: topNames.slice(0, 5),
          datasets: [{
            data: topQty.slice(0, 5),
            backgroundColor: doughnutColors,
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'right', labels: { color: '#fff', boxWidth: 10 } } }
        }
      });

      // BAR
      const ctxB = document.getElementById('barChart').getContext('2d');
      charts.bar = new Chart(ctxB, {
        type: 'bar',
        data: {
          labels: topNames.slice(0, 8),
          datasets: [{
            data: topQty.slice(0, 8),
            backgroundColor: 'rgba(79, 172, 254, 0.85)',
            borderRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { grid: { color: '#3d3d5c' }, ticks: { color: '#ddd' } },
            x: { grid: { display: false }, ticks: { color: '#ddd' } }
          }
        }
      });
    }

    function updateTables(stockRows, reqRows) {
      const tbodyStock = document.querySelector('#stockTable tbody');
      tbodyStock.innerHTML = '';
      stockRows.forEach(item => {
        const statusHtml = item.low
          ? '<span style="color:#ff4757; font-weight:bold;">Bajo</span>'
          : '<span style="color:#2ed573; font-weight:bold;">Normal</span>';

        tbodyStock.innerHTML += `<tr>
          <td>${item.codigo}</td>
          <td>${item.nombre}</td>
          <td>${item.cantidad}</td>
          <td>${statusHtml}</td>
        </tr>`;
      });

      const tbodyReq = document.querySelector('#reqTable tbody');
      tbodyReq.innerHTML = '';
      reqRows.forEach(r => {
        tbodyReq.innerHTML += `<tr>
          <td>${r.numero}</td>
          <td>${r.solicitante}</td>
          <td>${r.fecha}</td>
          <td>${r.estado}</td>
        </tr>`;
      });
    }

    async function loadData() {
      if (loading) return;
      loading = true;

      try {
        const res = await fetch('/api/dashboard/almacen/', { headers: { 'X-Requested-With': 'XMLHttpRequest' } });

        // Si Django te mand贸 al login (por sesi贸n expirada), recarga
        if (res.redirected) {
          window.location.href = res.url;
          return;
        }

        if (!res.ok) throw new Error('HTTP ' + res.status);

        const data = await res.json();

        document.getElementById('kpiValue').innerText = money.format(Number(data.kpis.valor_inventario || 0));
        document.getElementById('kpiOrders').innerText = data.kpis.req_pendientes ?? 0;
        document.getElementById('kpiLowStock').innerText = data.kpis.stock_bajo ?? 0;

        renderCharts(
          data.charts.mov_labels || [],
          data.charts.mov_in || [],
          data.charts.mov_out || [],
          data.charts.top_names || [],
          data.charts.top_qty || []
        );

        updateTables(data.tables.stock || [], data.tables.reqs || []);
      } catch (e) {
        console.error(e);
      } finally {
        loading = false;
      }
    }

    loadData();
    setInterval(loadData, 5000);
  </script>
</body>
</html>
