{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Dashboard | Telecable</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg: #0b1020;
      --bg2: #0f1630;
      --panel: rgba(255,255,255,0.06);
      --panel2: rgba(255,255,255,0.08);
      --border: rgba(255,255,255,0.10);
      --text: #ffffff;
      --muted: rgba(255,255,255,0.65);
      --muted2: rgba(255,255,255,0.45);

      --primary: #4facfe;
      --danger: #ff4757;
      --warn: #ff6b6b;
      --ok: #2ed573;

      --shadow: 0 10px 30px rgba(0,0,0,0.28);
      --radius: 18px;
      --radius2: 14px;
    }

    *{margin:0;padding:0;box-sizing:border-box;}
    body{
      font-family:'Poppins',sans-serif;
      background:
        radial-gradient(1000px 700px at 20% -10%, rgba(79,172,254,0.20), transparent 60%),
        radial-gradient(900px 700px at 110% 10%, rgba(255,71,87,0.16), transparent 55%),
        linear-gradient(180deg, var(--bg) 0%, #070a14 100%);
      color: var(--text);
      display:flex;
      height:100vh;
      overflow:hidden;
    }

    /* Sidebar */
    .sidebar{
      width: 270px;
      padding: 22px;
      background: rgba(10,14,30,0.70);
      border-right: 1px solid var(--border);
      backdrop-filter: blur(10px);
      box-shadow: 10px 0 30px rgba(0,0,0,0.22);
      display:flex;
      flex-direction:column;
      gap: 14px;
      z-index:10;
    }

    .brand{
      display:flex;
      align-items:center;
      gap: 12px;
      padding: 12px 10px 18px 10px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      margin-bottom: 6px;
    }
    .brand img{
      width: 42px;
      height: 42px;
      border-radius: 12px;
      object-fit: contain;
      background: rgba(255,255,255,0.92);
      padding: 6px;
      box-shadow: 0 8px 18px rgba(0,0,0,0.25);
    }
    .brand .title{
      display:flex;
      flex-direction:column;
      line-height:1.1;
    }
    .brand .title span:first-child{
      font-weight: 700;
      letter-spacing: 1px;
      text-transform: uppercase;
      font-size: 16px;
    }
    .brand .title span:last-child{
      font-size: 12px;
      color: var(--muted2);
      margin-top: 4px;
    }

    .menu-btn{
      background: transparent;
      border: 1px solid transparent;
      width: 100%;
      padding: 14px 14px;
      text-align: left;
      color: var(--muted);
      font-size: 14px;
      cursor: pointer;
      border-radius: 14px;
      display:flex;
      align-items:center;
      gap: 12px;
      transition: all 0.25s ease;
      text-decoration:none;
      user-select:none;
    }
    .menu-btn i{ font-size: 20px; }
    .menu-btn:hover{
      background: rgba(255,255,255,0.06);
      border-color: rgba(255,255,255,0.10);
      color: #fff;
      transform: translateY(-1px);
    }
    .menu-btn.active{
      background: linear-gradient(135deg, rgba(79,172,254,0.30), rgba(79,172,254,0.10));
      border-color: rgba(79,172,254,0.45);
      color:#fff;
      box-shadow: 0 10px 25px rgba(79,172,254,0.15);
    }

    .logout-btn{
      margin-top:auto;
      border: 1px solid rgba(255,71,87,0.30);
      color: rgba(255,71,87,0.95);
    }
    .logout-btn:hover{
      background: rgba(255,71,87,0.12);
      border-color: rgba(255,71,87,0.50);
      color: #fff;
    }

    /* Main */
    .main{
      flex:1;
      padding: 28px;
      overflow-y:auto;
    }

    .header{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap: 14px;
      flex-wrap: wrap;
      margin-bottom: 22px;
    }
    .header h2{
      font-size: 26px;
      font-weight: 650;
      letter-spacing: 0.2px;
    }
    .header p{
      color: var(--muted);
      font-size: 13px;
      margin-top: 6px;
    }

    .badge{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 10px 12px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 999px;
      backdrop-filter: blur(10px);
    }
    .badge i{ font-size: 20px; color: var(--primary); }
    .badge span{ font-size: 13px; color: rgba(255,255,255,0.9); }

    .section{ display:none; }
    .section.active{ display:block; animation: fadeIn 0.35s ease; }

    @keyframes fadeIn{
      from{ opacity:0; transform: translateY(10px); }
      to{ opacity:1; transform: translateY(0); }
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 18px;
    }

    .card{
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px;
      backdrop-filter: blur(10px);
    }

    .kpi{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 14px;
    }
    .kpi .left{
      display:flex;
      align-items:center;
      gap: 14px;
    }
    .kpi .icon{
      width: 46px;
      height: 46px;
      border-radius: 14px;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(79,172,254,0.15);
      border: 1px solid rgba(79,172,254,0.25);
    }
    .kpi .icon.danger{
      background: rgba(255,71,87,0.14);
      border-color: rgba(255,71,87,0.28);
    }
    .kpi .icon i{ font-size: 22px; color: #fff; opacity: 0.95; }
    .kpi .meta span{
      display:block;
      font-size: 12px;
      color: var(--muted2);
      letter-spacing: 0.6px;
      text-transform: uppercase;
    }
    .kpi .meta h3{
      margin-top: 4px;
      font-size: 28px;
      font-weight: 700;
    }

    .table-card{ margin-top: 16px; }
    .table-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    .table-head h4{
      font-size: 14px;
      font-weight: 650;
      color: rgba(255,255,255,0.95);
      display:flex;
      align-items:center;
      gap: 10px;
    }
    .table-head h4 i{
      color: var(--primary);
      font-size: 18px;
    }
    .sub{
      font-size: 12px;
      color: var(--muted2);
      margin-top: 4px;
    }

    table{
      width: 100%;
      border-collapse: collapse;
      border-radius: 14px;
      overflow: hidden;
    }
    thead th{
      text-align:left;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: rgba(255,255,255,0.75);
      padding: 12px 12px;
      border-bottom: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
    }
    tbody td{
      padding: 12px 12px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      font-size: 13px;
      color: rgba(255,255,255,0.88);
      vertical-align: middle;
    }
    tbody tr:hover td{
      background: rgba(255,255,255,0.03);
    }

    .pill{
      display:inline-flex;
      align-items:center;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
      color: rgba(255,255,255,0.85);
      white-space: nowrap;
      gap: 6px;
    }
    .pill.ok{
      border-color: rgba(46,213,115,0.35);
      background: rgba(46,213,115,0.10);
    }
    .pill.warn{
      border-color: rgba(255,107,107,0.35);
      background: rgba(255,107,107,0.10);
    }

    .btn{
      border: none;
      cursor:pointer;
      padding: 9px 14px;
      border-radius: 12px;
      font-weight: 650;
      font-size: 12px;
      letter-spacing: 0.2px;
      color:#fff;
      background: linear-gradient(135deg, rgba(79,172,254,0.95), rgba(0,242,254,0.75));
      box-shadow: 0 12px 24px rgba(79,172,254,0.18);
      transition: transform .15s ease, filter .15s ease;
      white-space: nowrap;
      text-decoration: none;
      display:inline-flex;
      align-items:center;
      gap: 8px;
    }
    .btn:hover{ transform: translateY(-1px); filter: brightness(1.05); }
    .btn:active{ transform: translateY(0); filter: brightness(0.98); }

    .btn.secondary{
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.12);
      box-shadow: none;
    }

    .btn.danger{
      background: rgba(255,71,87,0.14);
      border: 1px solid rgba(255,71,87,0.35);
      box-shadow: none;
    }

    .btn.small{ padding: 8px 10px; border-radius: 10px; font-size: 12px; }

    .btnrow{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .charts-grid{
      display:grid;
      grid-template-columns: 2fr 1fr;
      gap: 16px;
      margin-top: 16px;
    }
    .chart{
      height: 420px;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .chart h4{
      font-size: 13px;
      font-weight: 650;
      color: rgba(255,255,255,0.92);
    }
    .chart canvas{
      width:100% !important;
      height:100% !important;
    }

    /* Messages */
    .messages{
      display:flex;
      flex-direction:column;
      gap: 10px;
      margin: 12px 0 8px 0;
    }
    .msg{
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.90);
      font-size: 13px;
    }
    .msg.success{ border-color: rgba(46,213,115,0.35); background: rgba(46,213,115,0.10); }
    .msg.error{ border-color: rgba(255,71,87,0.40); background: rgba(255,71,87,0.10); }
    .msg.warning{ border-color: rgba(255,107,107,0.35); background: rgba(255,107,107,0.10); }
    .msg.info{ border-color: rgba(79,172,254,0.40); background: rgba(79,172,254,0.10); }

    /* Modal */
    .modal-backdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
      z-index: 1000;
    }
    .modal{
      width: min(720px, 100%);
      background: rgba(12,16,36,0.92);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 18px;
      box-shadow: 0 18px 40px rgba(0,0,0,0.45);
      backdrop-filter: blur(12px);
      overflow:hidden;
    }
    .modal-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
      padding: 16px 16px 12px 16px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    .modal-head h3{
      font-size: 15px;
      font-weight: 700;
    }
    .modal-head p{
      margin-top: 6px;
      font-size: 12px;
      color: rgba(255,255,255,0.65);
    }
    .modal-body{ padding: 16px; }
    .modal-row{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:flex-end;
      margin-bottom: 12px;
    }
    .field{
      flex:1;
      min-width: 210px;
    }
    .field .label{
      font-size:12px;
      color: rgba(255,255,255,.65);
      margin-bottom: 6px;
    }
    .field select, .field input{
      width:100%;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:#fff;
      outline:none;
    }
    .modal-actions{
      display:flex;
      justify-content:flex-end;
      gap: 10px;
      padding: 12px 16px 16px 16px;
      border-top: 1px solid rgba(255,255,255,0.08);
    }
    .xbtn{
      border:none;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      color:#fff;
      border-radius: 12px;
      padding: 8px 10px;
      cursor:pointer;
    }

    @media (max-width: 980px){
      body{ overflow:auto; height:auto; }
      .sidebar{ position: sticky; top:0; height: 100vh; }
      .grid{ grid-template-columns: 1fr; }
      .charts-grid{ grid-template-columns: 1fr; }
      .chart{ height: 360px; }
      .btnrow{ justify-content: flex-start; }
    }
  </style>
</head>

<body>
  <aside class="sidebar">
    <div class="brand">
      <img src="{% static 'inventario/img/logo.png' %}" alt="Logo">
      <div class="title">
        <span>TELECABLE</span>
        <span>Panel de Almac√©n</span>
      </div>
    </div>

    <button class="menu-btn active" data-tab="dashboard">
      <i class='bx bxs-dashboard'></i> Dashboard
    </button>

    <button class="menu-btn" data-tab="inventory">
      <i class='bx bxs-box'></i> Inventario
    </button>

    <button class="menu-btn" data-tab="reqs">
      <i class='bx bxs-receipt'></i> Requerimientos
    </button>

    <button class="menu-btn" data-tab="projects">
      <i class='bx bxs-folder'></i> Proyectos
    </button>

    <a class="menu-btn" href="{% url 'liquidacion_dashboard' %}"
       style="background: linear-gradient(135deg, rgba(46,213,115,0.30), rgba(46,213,115,0.10));
              border: 1px solid rgba(46,213,115,0.45); color:#fff;">
      <i class='bx bxs-calculator'></i> üìä Liquidaci√≥n
    </a>

    <a class="menu-btn logout-btn" href="{% url 'logout' %}">
      <i class='bx bx-log-out-circle'></i> Cerrar Sesi√≥n
    </a>
  </aside>

  <main class="main">
    <div class="header">
      <div>
        <h2 id="welcomeText">Resumen General</h2>
        <p>Sede: <b>{{ sede.nombre }}</b></p>
      </div>

      <div class="badge">
        <i class='bx bxs-user-circle'></i>
        <span>{{ request.user.username }}</span>
      </div>
    </div>

    <!-- DASHBOARD -->
    <section id="dashboard" class="section active">

      {% if sede.tipo == "CENTRAL" %}
        <div class="card" style="margin-bottom:16px;">
          <div class="table-head" style="margin-bottom:0;">
            <div>
              <h4><i class='bx bxs-factory'></i> REQ a Proveedor (solo CENTRAL)</h4>
              <div class="sub">
                Desde aqu√≠ CENTRAL puede crear requerimientos a proveedores y luego imprimirlos.
              </div>
            </div>
            <div class="btnrow">
              <a class="btn" href="{% url 'req_home' %}">
                <i class='bx bx-plus-circle'></i> Ir a REQ
              </a>
            </div>
          </div>
        </div>
      {% endif %}

      <div class="grid">
        <div class="card">
          <div class="kpi">
            <div class="left">
              <div class="icon">
                <i class='bx bxs-truck'></i>
              </div>
              <div class="meta">
                <span>REQ pendientes</span>
                <h3 id="kpiOrders">0</h3>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="kpi">
            <div class="left">
              <div class="icon danger">
                <i class='bx bxs-bell-ring'></i>
              </div>
              <div class="meta">
                <span>Stock bajo</span>
                <h3 id="kpiLowStock">0</h3>
              </div>
            </div>
          </div>
        </div>
      </div>

      {% if messages %}
        <div class="messages">
          {% for message in messages %}
            <div class="msg {{ message.tags|default:'info' }}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}

      <div class="card table-card">
        <div class="table-head">
          <div>
            <h4><i class='bx bxs-check-square'></i> REQ Pendientes (Acciones r√°pidas)</h4>
            <div class="sub">
              Convierte un REQ en SAL para preparar la entrega. Tambi√©n puedes imprimir el REQ (seg√∫n su tipo).
            </div>
          </div>
        </div>

        <table>
          <thead>
            <tr>
              <th>REQ</th>
              <th>Tipo</th>
              <th>Solicitante</th>
              <th>Fecha</th>
              <th>Estado</th>
              <th style="text-align:right;">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for r in ult_reqs %}
              <tr>
                <td>{{ r.numero|default:"(sin n√∫mero)" }}</td>

                <td>
                  {% if r.tipo_requerimiento == "PROVEEDOR" %}
                    <span class="pill warn"><i class='bx bx-store'></i> Proveedor</span>
                  {% elif r.tipo_requerimiento == "ENTRE_SEDES" %}
                    <span class="pill ok"><i class='bx bx-transfer'></i> Entre sedes</span>
                  {% elif r.tipo_requerimiento == "LOCAL" %}
                    <span class="pill"><i class='bx bx-home'></i> Local</span>
                  {% else %}
                    <span class="pill">(sin tipo)</span>
                  {% endif %}
                </td>

                <td>{{ r.responsable.username }}</td>
                <td>{{ r.fecha|date:"Y-m-d H:i" }}</td>
                <td><span class="pill">{{ r.get_estado_display }}</span></td>

                <td style="text-align:right;">
                  <div class="btnrow">
                    <a class="btn secondary small" target="_blank" href="{% url 'req_print' r.id %}">
                      <i class='bx bx-printer'></i> Imprimir
                    </a>

                    <form method="post" action="{% url 'req_to_sal' r.id %}" style="display:inline;">
                      {% csrf_token %}
                      <button type="submit" class="btn small">
                        <i class='bx bx-transfer-alt'></i> Convertir a SAL
                      </button>
                    </form>
                  </div>
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="6" style="text-align:center; color: rgba(255,255,255,0.65); padding: 18px;">
                  No hay REQs pendientes para procesar.
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="charts-grid">
        <div class="card chart">
          <h4>Flujo de Movimientos (√∫ltimos 60 min)</h4>
          <canvas id="lineChart"></canvas>
        </div>

        <div class="card chart">
          <h4>Top Productos (Stock)</h4>
          <canvas id="doughnutChart"></canvas>
        </div>

        <div class="card chart" style="grid-column: 1 / -1; height: 380px;">
          <h4>Stock (Top 8)</h4>
          <canvas id="barChart"></canvas>
        </div>
      </div>
    </section>

    <!-- INVENTORY -->
    <section id="inventory" class="section">
      <div class="card table-card">
        <div class="table-head">
          <div>
            <h4><i class='bx bxs-box'></i> Stock actual disponible</h4>
            <div class="sub">Vista r√°pida del stock en la sede.</div>
          </div>
        </div>
        <table id="stockTable">
          <thead>
            <tr>
              <th>C√≥d</th>
              <th>Producto</th>
              <th>Cant</th>
              <th>Estado</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card table-card">
        <div class="table-head">
          <div>
            <h4><i class='bx bxs-receipt'></i> Historial completo</h4>
            <div class="sub">REQs de la sede (seg√∫n API).</div>
          </div>
        </div>
        <table id="reqTable">
          <thead>
            <tr>
              <th>REQ</th>
              <th>Solicitante</th>
              <th>Fecha</th>
              <th>Estado</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- REQUERIMIENTOS -->
    <section id="reqs" class="section">
      <div class="card table-card">
        <div class="table-head">
          <div>
            <h4><i class='bx bxs-receipt'></i> Requerimientos</h4>
            <div class="sub">Crea, filtra y procesa REQs sin salir del dashboard.</div>
          </div>
          <div class="btnrow">
            <button class="btn small" id="btnNewReq">
              <i class='bx bx-plus-circle'></i> Nuevo REQ
            </button>
          </div>
        </div>

        <div id="reqsBox" class="msg">Abre esta pesta√±a para cargar REQs‚Ä¶</div>
        <div class="divider" style="height:1px;background:rgba(255,255,255,.08);margin:12px 0;"></div>

        <table>
          <thead>
            <tr>
              <th>REQ</th><th>Tipo</th><th>Solicitante</th><th>Fecha</th><th>Estado</th><th style="text-align:right;">Acciones</th>
            </tr>
          </thead>
          <tbody id="reqsTbody"></tbody>
        </table>
      </div>
    </section>

    <!-- PROYECTOS -->
    <section id="projects" class="section">
      <div class="card table-card">
        <div class="table-head">
          <div>
            <h4><i class='bx bxs-folder'></i> Proyectos</h4>
            <div class="sub">Crea y gestiona proyectos desde aqu√≠.</div>
          </div>
          <div class="btnrow">
            <button class="btn small" id="btnNewProject">
              <i class='bx bx-plus'></i> Nuevo Proyecto
            </button>
          </div>
        </div>

        <div id="projectsBox" class="msg">Aqu√≠ va tu m√≥dulo de proyectos.</div>
      </div>
    </section>
  </main>

  <!-- ‚úÖ MODAL NUEVO REQ -->
  <div id="reqModalBackdrop" class="modal-backdrop">
    <div class="modal">
      <div class="modal-head">
        <div>
          <h3><i class='bx bx-plus-circle'></i> Crear nuevo REQ</h3>
          <p>Selecciona el tipo. Si es <b>ENTRE_SEDES</b> pide CENTRAL destino, y si es <b>PROVEEDOR</b> pide proveedor.</p>
        </div>
        <button class="xbtn" id="btnCloseReqModal"><i class='bx bx-x'></i></button>
      </div>

      <div class="modal-body">
        <div id="reqModalMsg" class="msg error" style="display:none;"></div>

        <div class="modal-row">
          <div class="field">
            <div class="label">Tipo de requerimiento</div>
            <select id="reqTipo">
              <option value="LOCAL">LOCAL</option>
              <option value="ENTRE_SEDES">ENTRE_SEDES</option>
              <option value="PROVEEDOR">PROVEEDOR</option>
            </select>
          </div>

          <div class="field" id="wrapDestinoDash" style="display:none;">
            <div class="label">Sede destino (CENTRAL)</div>
            <select id="reqDestino">
              <option value="">-- seleccionar --</option>
              {% for s in sedes_central %}
                <option value="{{ s.id }}">{{ s.nombre }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="field" id="wrapProveedorDash" style="display:none;">
            <div class="label">Proveedor</div>
            <select id="reqProveedor">
              <option value="">-- seleccionar --</option>
              {% for p in proveedores %}
                <option value="{{ p.id }}">{{ p.razon_social }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div class="msg info" id="reqRulesHint">
          Reglas: LOCAL no usa proveedor ni destino. ENTRE_SEDES requiere destino CENTRAL. PROVEEDOR requiere proveedor y solo CENTRAL.
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn secondary" id="btnCancelReq">Cancelar</button>
        <button class="btn" id="btnCreateReq">
          <i class='bx bx-check'></i> Crear y continuar
        </button>
      </div>
    </div>
  </div>

  <script>
    // Helpers
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
      return "";
    }

    function escapeHtml(str){
      return (str || "").replace(/[&<>"']/g, (m) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    // Tabs + hooks
    document.querySelectorAll('.menu-btn[data-tab]').forEach(btn => {
      btn.addEventListener('click', async () => {
        const tabId = btn.getAttribute('data-tab');

        document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.menu-btn[data-tab]').forEach(el => el.classList.remove('active'));

        document.getElementById(tabId).classList.add('active');
        btn.classList.add('active');

        if (tabId === "reqs") await loadReqs();
      });
    });

    // Charts + tables (dashboard API)
    let charts = {};
    let loading = false;

    function renderCharts(lineLabels, lineIn, lineOut, topNames, topQty) {
      if (charts.line) charts.line.destroy();
      if (charts.doughnut) charts.doughnut.destroy();
      if (charts.bar) charts.bar.destroy();

      const ctxLine = document.getElementById('lineChart').getContext('2d');
      charts.line = new Chart(ctxLine, {
        type: 'line',
        data: {
          labels: lineLabels,
          datasets: [
            { label: 'IN', data: lineIn, borderColor: '#4facfe', backgroundColor: 'rgba(79, 172, 254, 0.10)', tension: 0.35, fill: true, pointRadius: 0 },
            { label: 'OUT', data: lineOut, borderColor: '#ff6b6b', backgroundColor: 'rgba(255, 107, 107, 0.08)', tension: 0.35, fill: true, pointRadius: 0 }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { labels: { color: 'rgba(255,255,255,0.85)' } } },
          scales: {
            y: { grid: { color: 'rgba(255,255,255,0.08)' }, ticks: { color: 'rgba(255,255,255,0.70)' } },
            x: { grid: { display: false }, ticks: { color: 'rgba(255,255,255,0.70)', maxTicksLimit: 10 } }
          }
        }
      });

      const doughnutColors = ['#ff6b6b', '#4facfe', '#DD2476', '#FF512F', '#8e44ad'];
      const ctxD = document.getElementById('doughnutChart').getContext('2d');
      charts.doughnut = new Chart(ctxD, {
        type: 'doughnut',
        data: {
          labels: topNames.slice(0, 5),
          datasets: [{ data: topQty.slice(0, 5), backgroundColor: doughnutColors, borderWidth: 0 }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'right', labels: { color: 'rgba(255,255,255,0.85)', boxWidth: 10 } } }
        }
      });

      const ctxB = document.getElementById('barChart').getContext('2d');
      charts.bar = new Chart(ctxB, {
        type: 'bar',
        data: {
          labels: topNames.slice(0, 8),
          datasets: [{ data: topQty.slice(0, 8), backgroundColor: 'rgba(79, 172, 254, 0.85)', borderRadius: 8 }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { grid: { color: 'rgba(255,255,255,0.08)' }, ticks: { color: 'rgba(255,255,255,0.70)' } },
            x: { grid: { display: false }, ticks: { color: 'rgba(255,255,255,0.70)' } }
          }
        }
      });
    }

    function updateTables(stockRows, reqRows) {
      const tbodyStock = document.querySelector('#stockTable tbody');
      tbodyStock.innerHTML = '';
      (stockRows || []).forEach(item => {
        const statusHtml = item.low
          ? '<span class="pill" style="border-color: rgba(255,71,87,0.40); background: rgba(255,71,87,0.10); color: rgba(255,255,255,0.92);">Bajo</span>'
          : '<span class="pill" style="border-color: rgba(46,213,115,0.35); background: rgba(46,213,115,0.10); color: rgba(255,255,255,0.92);">Normal</span>';

        tbodyStock.innerHTML += `
          <tr>
            <td>${escapeHtml(item.codigo)}</td>
            <td>${escapeHtml(item.nombre)}</td>
            <td>${escapeHtml(String(item.cantidad ?? ""))}</td>
            <td>${statusHtml}</td>
          </tr>`;
      });

      const tbodyReq = document.querySelector('#reqTable tbody');
      tbodyReq.innerHTML = '';
      (reqRows || []).forEach(r => {
        tbodyReq.innerHTML += `
          <tr>
            <td>${escapeHtml(r.numero)}</td>
            <td>${escapeHtml(r.solicitante)}</td>
            <td>${escapeHtml(r.fecha)}</td>
            <td>${escapeHtml(r.estado)}</td>
          </tr>`;
      });
    }

    async function loadData() {
      if (loading) return;
      loading = true;

      try {
        const res = await fetch('/api/dashboard/almacen/', { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
        if (res.redirected) { window.location.href = res.url; return; }
        if (!res.ok) throw new Error('HTTP ' + res.status);

        const data = await res.json();

        document.getElementById('kpiOrders').innerText = data.kpis?.req_pendientes ?? 0;
        document.getElementById('kpiLowStock').innerText = data.kpis?.stock_bajo ?? 0;

        renderCharts(
          data.charts?.mov_labels || [],
          data.charts?.mov_in || [],
          data.charts?.mov_out || [],
          data.charts?.top_names || [],
          data.charts?.top_qty || []
        );

        updateTables(data.tables?.stock || [], data.tables?.reqs || []);
      } catch (e) {
        console.error(e);
      } finally {
        loading = false;
      }
    }

    // REQS module (pesta√±a Requerimientos)
    function pillTipo(tipo){
      if (tipo === "PROVEEDOR") return `<span class="pill warn"><i class='bx bx-store'></i> Proveedor</span>`;
      if (tipo === "ENTRE_SEDES") return `<span class="pill ok"><i class='bx bx-transfer'></i> Entre sedes</span>`;
      if (tipo === "LOCAL") return `<span class="pill"><i class='bx bx-home'></i> Local</span>`;
      return `<span class="pill">(sin tipo)</span>`;
    }

    function renderReqs(rows){
      const box = document.getElementById("reqsBox");
      const tb = document.getElementById("reqsTbody");

      if (!rows || rows.length === 0){
        box.className = "msg";
        box.textContent = "No hay requerimientos por mostrar.";
        box.style.display = "block";
        tb.innerHTML = "";
        return;
      }

      box.style.display = "none";
      const csrftoken = getCookie("csrftoken");

      tb.innerHTML = rows.map(r => `
        <tr>
          <td>${escapeHtml(r.numero || "(sin n√∫mero)")}</td>
          <td>${pillTipo((r.tipo_requerimiento || "").toUpperCase())}</td>
          <td>${escapeHtml(r.solicitante || "")}</td>
          <td>${escapeHtml(r.fecha || "")}</td>
          <td><span class="pill">${escapeHtml(r.estado || "")}</span></td>
          <td style="text-align:right;">
            <div class="btnrow">
              <a class="btn secondary small" target="_blank" href="/req/${r.id}/print/">
                <i class='bx bx-printer'></i> Imprimir
              </a>
              <form method="post" action="/req/${r.id}/to-sal/" style="display:inline;">
                <input type="hidden" name="csrfmiddlewaretoken" value="${escapeHtml(csrftoken)}">
                <button type="submit" class="btn small">
                  <i class='bx bx-transfer-alt'></i> SAL
                </button>
              </form>
            </div>
          </td>
        </tr>
      `).join("");
    }

    async function loadReqs(){
      const box = document.getElementById("reqsBox");
      const tb = document.getElementById("reqsTbody");

      box.className = "msg";
      box.textContent = "Cargando requerimientos...";
      box.style.display = "block";
      tb.innerHTML = "";

      try{
        const res = await fetch('/api/dashboard/almacen/', { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
        if (res.redirected) { window.location.href = res.url; return; }
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data.error || ("HTTP " + res.status));

        // ‚úÖ FIX: tu API devuelve "reqs_pendientes" (NO tables.reqs)
        renderReqs(data.reqs_pendientes || []);
      }catch(e){
        box.className = "msg error";
        box.textContent = "Error cargando requerimientos.";
        console.error(e);
      }
    }

    // ‚úÖ Modal Nuevo REQ
    const sedeTipo = "{{ sede.tipo|default:'' }}";
    const reqModal = document.getElementById("reqModalBackdrop");
    const btnNewReq = document.getElementById("btnNewReq");
    const btnCloseReqModal = document.getElementById("btnCloseReqModal");
    const btnCancelReq = document.getElementById("btnCancelReq");
    const btnCreateReq = document.getElementById("btnCreateReq");

    const tipoEl = document.getElementById("reqTipo");
    const wrapDestino = document.getElementById("wrapDestinoDash");
    const destinoEl = document.getElementById("reqDestino");
    const wrapProveedor = document.getElementById("wrapProveedorDash");
    const proveedorEl = document.getElementById("reqProveedor");
    const msgEl = document.getElementById("reqModalMsg");
    const hintEl = document.getElementById("reqRulesHint");

    const endpointSetTipo = "/req/set-tipo/";

    function openReqModal(){
      msgEl.style.display = "none";
      msgEl.textContent = "";

      // Ajustar opciones seg√∫n sede (reglas del clean)
      const opts = Array.from(tipoEl.querySelectorAll("option"));
      opts.forEach(o => o.style.display = "block");

      if ((sedeTipo || "").toUpperCase() === "CENTRAL"){
        // CENTRAL: LOCAL + PROVEEDOR, NO ENTRE_SEDES
        const optEntre = tipoEl.querySelector('option[value="ENTRE_SEDES"]');
        if (optEntre) optEntre.style.display = "none";
        tipoEl.value = "LOCAL";
      } else {
        // NO CENTRAL: LOCAL + ENTRE_SEDES, NO PROVEEDOR
        const optProv = tipoEl.querySelector('option[value="PROVEEDOR"]');
        if (optProv) optProv.style.display = "none";
        tipoEl.value = "LOCAL";
      }

      paintReqModal();
      reqModal.style.display = "flex";
    }

    function closeReqModal(){
      reqModal.style.display = "none";
    }

    function paintReqModal(){
      const t = (tipoEl.value || "").toUpperCase();

      wrapDestino.style.display = (t === "ENTRE_SEDES") ? "block" : "none";
      wrapProveedor.style.display = (t === "PROVEEDOR") ? "block" : "none";

      if (t === "LOCAL"){
        hintEl.textContent = "LOCAL: no usa proveedor ni sede destino.";
      } else if (t === "ENTRE_SEDES"){
        hintEl.textContent = "ENTRE_SEDES: requiere sede destino CENTRAL (Jauja).";
      } else if (t === "PROVEEDOR"){
        hintEl.textContent = "PROVEEDOR: solo CENTRAL y requiere proveedor.";
      } else {
        hintEl.textContent = "";
      }
    }

    if (btnNewReq){
      btnNewReq.addEventListener("click", openReqModal);
    }
    if (btnCloseReqModal) btnCloseReqModal.addEventListener("click", closeReqModal);
    if (btnCancelReq) btnCancelReq.addEventListener("click", closeReqModal);

    reqModal.addEventListener("click", (e) => {
      if (e.target === reqModal) closeReqModal();
    });

    tipoEl.addEventListener("change", paintReqModal);

    async function postReqTipo(){
      msgEl.style.display = "none";
      msgEl.textContent = "";

      const tipo = (tipoEl.value || "").toUpperCase();
      const destino = (destinoEl?.value || "").trim();
      const proveedor = (proveedorEl?.value || "").trim();

      // Validaciones frontend
      if (tipo === "ENTRE_SEDES" && !destino){
        msgEl.textContent = "Selecciona una sede CENTRAL destino.";
        msgEl.style.display = "block";
        return;
      }
      if (tipo === "PROVEEDOR" && !proveedor){
        msgEl.textContent = "Selecciona un proveedor.";
        msgEl.style.display = "block";
        return;
      }

      btnCreateReq.disabled = true;

      try{
        const fd = new FormData();
        fd.append("tipo_requerimiento", tipo);
        if (destino) fd.append("sede_destino_id", destino);
        if (proveedor) fd.append("proveedor_id", proveedor);

        const res = await fetch(endpointSetTipo, {
          method: "POST",
          headers: {
            "X-Requested-With": "XMLHttpRequest",
            "X-CSRFToken": getCookie("csrftoken"),
          },
          body: fd
        });

        const data = await res.json().catch(() => ({}));

        if (!res.ok){
          if (res.status === 404){
            throw new Error("HTTP 404: No existe la ruta del POST. Revisa urls.py (req_set_tipo_requerimiento).");
          }
          throw new Error(data.error || ("HTTP " + res.status));
        }

        // ‚úÖ OK: cerramos modal y vamos al flujo normal
        closeReqModal();
        window.location.href = "/req/";
      }catch(e){
        msgEl.textContent = e.message || "Error creando REQ.";
        msgEl.style.display = "block";
      }finally{
        btnCreateReq.disabled = false;
      }
    }

    if (btnCreateReq){
      btnCreateReq.addEventListener("click", postReqTipo);
    }

    // Proyectos placeholder
    const btnNewProject = document.getElementById("btnNewProject");
    if (btnNewProject){
      btnNewProject.addEventListener("click", () => {
        alert("Aqu√≠ luego abrimos el m√≥dulo/modal para crear Proyectos ‚úÖ");
      });
    }

    // Init dashboard
    loadData();
    setInterval(loadData, 5000);
  </script>
</body>
</html>
