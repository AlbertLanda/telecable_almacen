{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Usuarios | Telecable</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    :root{ --bg: #0b0f1a; --bg2: #0f172a; --panel: rgba(255,255,255,0.06); --border: rgba(255,255,255,0.10); --text: #e6edf3; --muted: #8b949e; --primary: #4facfe; --accent2: #00d4ff; --success: #2ed573; --danger: #ff4757; --radius: 18px; }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: 'Poppins', sans-serif; background: radial-gradient(1000px 500px at 20% 0%, rgba(79,172,254,0.18), transparent 60%), linear-gradient(180deg, var(--bg), var(--bg2)); color: var(--text); display: flex; height: 100vh; overflow: hidden; }
    
    .sidebar{ width: 270px; padding: 20px; background: rgba(255,255,255,0.04); border-right: 1px solid var(--border); display:flex; flex-direction:column; gap: 10px; }
    .brand{ display:flex; align-items:center; gap: 12px; padding: 12px; margin-bottom: 20px; }
    .brand img{ width: 44px; border-radius: 12px; background: rgba(255,255,255,0.08); padding: 6px; }
    
    .menu-btn{ width: 100%; display:flex; align-items:center; gap: 12px; text-decoration:none; color: var(--muted); padding: 12px 14px; border-radius: 14px; transition: 0.2s; }
    .menu-btn:hover, .menu-btn.active { background: rgba(255,255,255,0.06); color: var(--text); }
    .menu-btn.active { border-left: 3px solid var(--primary); background: linear-gradient(90deg, rgba(79,172,254,0.1), transparent); }
    .menu-btn.danger { margin-top:auto; color: var(--danger); }

    .main { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }
    .topbar{ display:flex; justify-content:space-between; align-items:center; margin-bottom: 25px; }
    
    .tabs-container { margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; }
    .tab-btn { padding: 10px 20px; border-radius: 12px; background: rgba(255,255,255,0.05); color: var(--muted); text-decoration: none; font-size: 13px; font-weight: 600; transition: 0.2s; border: 1px solid var(--border); }
    .tab-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }
    .tab-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3); }

    .card { background: var(--panel); border: 1px solid var(--border); border-radius: var(--radius); padding: 0; overflow: hidden; }
    table { width:100%; border-collapse:collapse; }
    thead th { text-align:left; font-size: 11px; text-transform: uppercase; color: var(--muted); padding: 18px; border-bottom: 1px solid var(--border); background: rgba(0,0,0,0.2); }
    tbody td { padding: 18px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 13px; vertical-align: middle; }
    tbody tr:hover { background: rgba(255,255,255,0.02); }

    .btn-icon { width: 32px; height: 32px; border-radius: 8px; background: rgba(255,255,255,0.05); color: var(--muted); display: inline-flex; justify-content: center; align-items: center; cursor: pointer; transition: 0.2s; border:none; margin-right: 5px; }
    .btn-icon.edit:hover { color: var(--primary); background: rgba(79, 172, 254, 0.15); }
    .btn-icon.del:hover { color: var(--danger); background: rgba(255, 71, 87, 0.15); }

    /* ----- ESTILOS DE BOTONES MEJORADOS ----- */
    .btn-create { 
        background: linear-gradient(135deg, var(--primary), var(--accent2)); 
        color: #fff; border: none; padding: 12px 20px; border-radius: 12px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 8px; text-decoration: none; 
        box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3); transition: 0.2s; 
    }
    .btn-create:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0, 212, 255, 0.4); }

    .btn-outline {
        background: transparent; border: 1px solid var(--border); color: var(--muted); box-shadow: none;
    }
    .btn-outline:hover {
        background: rgba(255,255,255,0.05); color: #fff; border-color: rgba(255,255,255,0.3); transform: translateY(-2px);
    }
    /* --------------------------------------- */

    /* Modal */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); display: none; justify-content: center; align-items: center; z-index: 100; }
    .modal-overlay.open { display: flex; }
    .modal-card { background: #131a28; border: 1px solid var(--border); width: 450px; padding: 30px; border-radius: 24px; box-shadow: 0 30px 60px rgba(0,0,0,0.7); }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; font-size: 11px; color: var(--muted); margin-bottom: 5px; text-transform: uppercase; }
    .form-control { width: 100%; padding: 12px; background: rgba(0,0,0,0.3); border: 1px solid var(--border); color: #fff; border-radius: 10px; outline: none; transition: 0.2s; }
    .form-control:focus { border-color: var(--primary); }
    select.form-control option { background: #131a28; }
  </style>
</head>
<body>
  <aside class="sidebar">
    <div class="brand"><img src="{% static 'inventario/img/logo.png' %}" alt="Logo"><h3>TELECABLE</h3></div>
    <nav class="menu">
      <a href="{% url 'dash_admin' %}" class="menu-btn"><i class='bx bxs-dashboard'></i> <span>Dashboard</span></a>
      <a href="{% url 'inventory_list' %}" class="menu-btn"><i class='bx bx-box'></i> <span>Inventario</span></a>
      <a href="{% url 'scan' %}" class="menu-btn"><i class='bx bx-qr-scan'></i> <span>Escanear</span></a>
      <a href="{% url 'usuarios_list' %}" class="menu-btn active"><i class='bx bxs-group'></i> <span>Usuarios</span></a>
      <a href="{% url 'logout' %}" class="menu-btn danger"><i class='bx bx-log-out-circle'></i> <span>Salir</span></a>
    </nav>
  </aside>

  <main class="main">
    <header class="topbar">
      <div><h2>Gestión de Usuarios</h2><p style="color:var(--muted)">Sede: <b style="color:var(--primary)">{{ sede_activa.nombre }}</b></p></div>
    </header>

    <div class="tabs-container">
        {% for s in sedes_disponibles %}
            <a href="?sede_id={{ s.id }}" class="tab-btn {% if s.id == sede_activa.id %}active{% endif %}">
                {{ s.nombre }}
            </a>
        {% endfor %}
    </div>

    <div class="card">
        <table>
            <thead>
                <tr>
                    <th>Usuario</th>
                    <th>Rol</th>
                    <th>Sede Actual</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for p in usuarios %}
                <tr>
                    <td style="font-weight: 600; color: #fff;">{{ p.user.username }}</td>
                    <td><span style="padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 700; background: rgba(255,255,255,0.1);">{{ p.rol }}</span></td>
                    <td style="color: var(--primary);">{{ p.sede_principal.nombre }}</td>
                    <td>
                        <button class="btn-icon edit" onclick="openEditModal('{{ p.user.id }}', '{{ p.user.username }}', '{{ p.rol }}', '{{ p.sede_principal.id }}')">
                            <i class='bx bx-edit-alt'></i>
                        </button>
                        <button class="btn-icon del" onclick="confirmDelete('{{ p.user.id }}', '{{ p.user.username }}')">
                            <i class='bx bx-trash'></i>
                        </button>
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="4" style="text-align: center; padding: 40px; color: var(--muted);">No hay usuarios activos aquí.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
  </main>

  <div class="modal-overlay" id="editModal">
      <div class="modal-card">
          <h3 style="margin-bottom: 20px;">Editar Usuario</h3>
          <form method="POST" id="editForm" action="" autocomplete="off">
              {% csrf_token %}
              
              <div class="form-group">
                  <label>MOVER A SEDE</label>
                  <select name="sede_id" id="editSede" class="form-control">
                      {% for s in sedes_disponibles %}
                        <option value="{{ s.id }}">{{ s.nombre }}</option>
                      {% endfor %}
                  </select>
              </div>

              <div class="form-group"><label>USUARIO</label><input type="text" name="username" id="editUsername" class="form-control uppercase-input" required></div>
              
              <div class="form-group">
                  <label>ROL</label>
                  <select name="rol" id="editRol" class="form-control">
                      <option value="ADMIN">ADMINISTRADOR</option>
                      <option value="ALMACEN">ALMACEN</option>
                      <option value="SOLICITANTE">TÉCNICO</option>
                  </select>
              </div>

              <div style="display: flex; gap: 15px; margin-top: 30px;">
                  <button type="button" class="btn-create btn-outline" onclick="closeModal('editModal')" style="flex:1; justify-content:center;">
                      Cancelar
                  </button>
                  <button type="submit" class="btn-create" style="flex:1; justify-content:center;">
                      <i class='bx bx-save'></i> Actualizar
                  </button>
              </div>
          </form>
      </div>
  </div>

  <script>
      function openEditModal(id, username, rol, sedeId) {
          document.getElementById('editUsername').value = username;
          document.getElementById('editRol').value = rol;
          document.getElementById('editSede').value = sedeId;
          document.getElementById('editForm').action = "/usuarios/editar/" + id + "/";
          document.getElementById('editModal').classList.add('open');
      }

      function closeModal(modalId) { document.getElementById(modalId).classList.remove('open'); }
      document.querySelectorAll('.uppercase-input').forEach(i => i.addEventListener('input', function() { this.value = this.value.toUpperCase(); }));

      function confirmDelete(id, name) {
          Swal.fire({
              title: '¿Desactivar a ' + name + '?',
              text: "Ya no podrá acceder al sistema.",
              icon: 'warning',
              showCancelButton: true,
              confirmButtonColor: '#ff4757',
              cancelButtonColor: '#303030',
              confirmButtonText: 'Sí, desactivar',
              background: '#131a28', color: '#fff'
          }).then((result) => {
              if (result.isConfirmed) window.location.href = "/usuarios/eliminar/" + id + "/";
          })
      }

      {% if messages %}
        {% for message in messages %}
            Swal.fire({ icon: "{% if message.tags == 'success' %}success{% else %}error{% endif %}", title: "{{ message }}", toast: true, position: 'top-end', showConfirmButton: false, timer: 3000, background: '#131a28', color: '#fff' });
        {% endfor %}
      {% endif %}
  </script>
</body>
</html>