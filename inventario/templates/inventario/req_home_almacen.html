{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>REQ Proveedor | Almacén</title>

  <style>
    :root{
      --bg:#0b1020; --panel:rgba(255,255,255,.06); --border:rgba(255,255,255,.12);
      --text:#fff; --muted:rgba(255,255,255,.65);
      --primary:#4facfe; --danger:#ff4757; --ok:#2ed573;
      --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1000px 700px at 20% -10%, rgba(79,172,254,.20), transparent 60%),
                  radial-gradient(900px 700px at 110% 10%, rgba(255,71,87,.16), transparent 55%),
                  linear-gradient(180deg, var(--bg) 0%, #070a14 100%);
      color:var(--text);
    }
    .wrap{max-width:1200px; margin:0 auto; padding:22px;}
    .top{
      display:flex; justify-content:space-between; align-items:flex-end; gap:12px; flex-wrap:wrap;
      margin-bottom:14px;
    }
    h1{font-size:24px; margin:0}
    .meta{color:var(--muted); font-size:13px; margin-top:6px}
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:8px 10px; border-radius:999px;
      background:var(--panel); border:1px solid var(--border);
      color:rgba(255,255,255,.9); font-size:13px;
    }
    .grid{display:grid; grid-template-columns: 1.35fr .65fr; gap:14px;}
    .card{
      background:var(--panel); border:1px solid var(--border);
      border-radius:var(--r); padding:14px;
      backdrop-filter: blur(10px);
    }
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    input, button{
      border-radius:14px; border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06); color:#fff;
      padding:10px 12px; outline:none;
    }
    input::placeholder{color:rgba(255,255,255,.45)}
    .btn{
      cursor:pointer; border:none;
      background:linear-gradient(135deg, rgba(79,172,254,.95), rgba(0,242,254,.75));
      font-weight:700;
    }
    .btn.secondary{background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.14); font-weight:650;}
    .btn.danger{background:rgba(255,71,87,.16); border:1px solid rgba(255,71,87,.35); color:#fff;}
    .btn.ok{background:rgba(46,213,115,.14); border:1px solid rgba(46,213,115,.35); color:#fff;}
    .btn.small{padding:8px 10px; border-radius:12px; font-size:12px;}
    .muted{color:var(--muted); font-size:12px}
    .list{display:flex; flex-direction:column; gap:10px; margin-top:12px;}
    .item{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px; border-radius:16px;
      background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.10);
    }
    .item .name{font-weight:700}
    .item .code{color:rgba(255,255,255,.55); font-size:12px; margin-top:2px}
    .qty{width:92px; text-align:center}
    .hr{height:1px; background:rgba(255,255,255,.10); margin:12px 0;}
    .msg{padding:10px 12px; border-radius:14px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.06); font-size:13px;}
    .msg.error{border-color: rgba(255,71,87,.35); background: rgba(255,71,87,.10);}
    .msg.ok{border-color: rgba(46,213,115,.35); background: rgba(46,213,115,.10);}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr;} }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>REQ a Proveedor (Almacén - Jauja)</h1>
        <div class="meta">
          Usuario: <b>{{ request.user.username }}</b> · Sede: <b>{{ sede.nombre }}</b> · Ubicación: <b>{{ ubicacion.nombre }}</b>
        </div>
      </div>
      <div class="pill">
        Tipo: <b>PROVEEDOR</b> (forzado por ALMACÉN CENTRAL)
      </div>
    </div>

    {% if messages %}
      <div style="display:flex; flex-direction:column; gap:10px; margin-bottom:12px;">
        {% for message in messages %}
          <div class="msg {{ message.tags|default:'' }}">{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}

    <div class="grid">
      <!-- CATALOGO -->
      <div class="card">
        <div class="row" style="justify-content:space-between;">
          <div>
            <div style="font-weight:800;">Materiales</div>
            <div class="muted">Busca y agrega productos (en proveedor no se valida stock).</div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="row">
          <input id="q" style="flex:1; min-width:220px" placeholder="Buscar por nombre o código..." />
          <button class="btn" id="btnBuscar">Buscar</button>
        </div>

        <div id="catalogo" class="list"></div>
      </div>

      <!-- CARRITO -->
      <div class="card">
        <div class="row" style="justify-content:space-between;">
          <div>
            <div style="font-weight:800;">Carrito</div>
            <div class="muted">REQ borrador</div>
          </div>
          <div class="row">
            <a class="btn secondary small" target="_blank" href="{% url 'req_print' req.id %}">Imprimir</a>
          </div>
        </div>

        <div class="hr"></div>

        <div id="carrito" class="list"></div>

        <div class="hr"></div>

        <form method="post" action="{% url 'req_enviar' req.id %}">
          {% csrf_token %}
          <button class="btn ok" style="width:100%;">Enviar REQ</button>
        </form>
        <div class="muted" style="margin-top:10px;">
          Al enviar, pasa a <b>PENDIENTE</b> y podrás procesarlo desde el panel.
        </div>
      </div>
    </div>
  </div>

<script>
  // CSRF
  function getCookie(name) {
    const v = `; ${document.cookie}`;
    const parts = v.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }
  const csrftoken = getCookie('csrftoken');

  function el(tag, html) {
    const d = document.createElement(tag);
    d.innerHTML = html;
    return d.firstElementChild;
  }

  async function fetchJSON(url, opts={}) {
    const res = await fetch(url, opts);
    const data = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(data.error || ('HTTP ' + res.status));
    return data;
  }

  // Render catálogo
  function renderCatalogo(rows) {
    const box = document.getElementById('catalogo');
    box.innerHTML = '';

    if (!rows || rows.length === 0) {
      box.appendChild(el('div', `<div class="msg">Sin resultados.</div>`));
      return;
    }

    rows.forEach(r => {
      const node = el('div', `
        <div class="item">
          <div>
            <div class="name">${r.nombre}</div>
            <div class="code">${r.codigo || ''} · Disponible: ${r.disponible ?? 0} ${r.unidad || ''}</div>
          </div>
          <div class="row" style="justify-content:flex-end;">
            <input class="qty" type="number" min="1" value="1" />
            <button class="btn small">Agregar</button>
          </div>
        </div>
      `);

      const qty = node.querySelector('input');
      const btn = node.querySelector('button');

      btn.addEventListener('click', async () => {
        const cantidad = parseInt(qty.value || '1', 10);
        if (!cantidad || cantidad <= 0) return;

        btn.disabled = true;
        try {
          await fetchJSON('/req/add-producto/', {
            method: 'POST',
            headers: {
              'X-Requested-With': 'XMLHttpRequest',
              'Content-Type': 'application/x-www-form-urlencoded',
              'X-CSRFToken': csrftoken
            },
            body: new URLSearchParams({
              producto_id: r.producto_id,
              cantidad: String(cantidad)
            })
          });
          await cargarCarrito();
        } catch (e) {
          alert(e.message);
        } finally {
          btn.disabled = false;
        }
      });

      box.appendChild(node);
    });
  }

  // Render carrito
  function renderCarrito(items) {
    const box = document.getElementById('carrito');
    box.innerHTML = '';

    if (!items || items.length === 0) {
      box.appendChild(el('div', `<div class="msg">Sin ítems todavía. Agrega desde el catálogo.</div>`));
      return;
    }

    items.forEach(it => {
      const node = el('div', `
        <div class="item">
          <div>
            <div class="name">${it.nombre}</div>
            <div class="code">${it.codigo || ''} · ${it.unidad || ''}</div>
          </div>
          <div class="row" style="justify-content:flex-end;">
            <input class="qty" type="number" min="1" value="${it.cantidad}" />
            <button class="btn secondary small">Actualizar</button>
            <button class="btn danger small">Quitar</button>
          </div>
        </div>
      `);

      const qty = node.querySelector('input');
      const btnUpd = node.querySelectorAll('button')[0];
      const btnDel = node.querySelectorAll('button')[1];

      btnUpd.addEventListener('click', async () => {
        const cantidad = parseInt(qty.value || '1', 10);
        if (!cantidad || cantidad <= 0) return;

        btnUpd.disabled = true;
        try {
          await fetchJSON('/req/set-qty/', {
            method: 'POST',
            headers: {
              'X-Requested-With': 'XMLHttpRequest',
              'Content-Type': 'application/x-www-form-urlencoded',
              'X-CSRFToken': csrftoken
            },
            body: new URLSearchParams({
              producto_id: it.producto_id,
              cantidad: String(cantidad)
            })
          });
          await cargarCarrito();
        } catch (e) {
          alert(e.message);
        } finally {
          btnUpd.disabled = false;
        }
      });

      btnDel.addEventListener('click', async () => {
        btnDel.disabled = true;
        try {
          await fetchJSON('/req/remove-producto/', {
            method: 'POST',
            headers: {
              'X-Requested-With': 'XMLHttpRequest',
              'Content-Type': 'application/x-www-form-urlencoded',
              'X-CSRFToken': csrftoken
            },
            body: new URLSearchParams({ producto_id: it.producto_id })
          });
          await cargarCarrito();
        } catch (e) {
          alert(e.message);
        } finally {
          btnDel.disabled = false;
        }
      });

      box.appendChild(node);
    });
  }

  async function buscar() {
    const q = (document.getElementById('q').value || '').trim();
    try {
      const data = await fetchJSON('/req/catalogo/?modo=proveedor&q=' + encodeURIComponent(q), {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      });
      renderCatalogo(data.results || []);
    } catch (e) {
      alert(e.message);
    }
  }

  async function cargarCarrito() {
    try {
      const data = await fetchJSON('/req/carrito/', { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
      renderCarrito(data.items || []);
    } catch (e) {
      // si se cae por sesión, etc
      console.error(e);
    }
  }

  document.getElementById('btnBuscar').addEventListener('click', buscar);
  document.getElementById('q').addEventListener('keydown', (ev) => {
    if (ev.key === 'Enter') { ev.preventDefault(); buscar(); }
  });

  // init
  buscar();
  cargarCarrito();
</script>
</body>
</html>
