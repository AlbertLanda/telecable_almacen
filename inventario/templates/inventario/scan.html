{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Escanear | Telecable</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    /* --- TEMA DARK --- */
    :root{ --bg: #0b0f1a; --bg2: #0f172a; --panel: rgba(255,255,255,0.06); --border: rgba(255,255,255,0.10); --text: #e6edf3; --muted: #8b949e; --primary: #4facfe; --primary-dark: #00d4ff; --success: #2ed573; --danger: #ff4757; --radius: 18px; }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: 'Poppins', sans-serif; background: radial-gradient(1000px 500px at 20% 0%, rgba(79,172,254,0.18), transparent 60%), radial-gradient(900px 450px at 90% 10%, rgba(0,212,255,0.12), transparent 60%), linear-gradient(180deg, var(--bg), var(--bg2)); color: var(--text); display: flex; height: 100vh; overflow: hidden; }
    
    .sidebar{ width: 270px; padding: 20px; background: rgba(255,255,255,0.04); border-right: 1px solid var(--border); backdrop-filter: blur(12px); display:flex; flex-direction:column; gap: 10px; z-index: 10; }
    .brand{ display:flex; align-items:center; gap: 12px; padding: 12px; border-radius: 16px; background: rgba(255,255,255,0.05); margin-bottom: 20px; }
    .brand img{ width: 44px; border-radius: 12px; background: rgba(255,255,255,0.08); padding: 6px; }
    .menu-btn{ width: 100%; display:flex; align-items:center; gap: 12px; text-decoration:none; color: var(--muted); padding: 12px 14px; border-radius: 14px; transition: 0.2s; }
    .menu-btn:hover{ background: rgba(255,255,255,0.06); color: var(--text); }
    .menu-btn.active{ background: linear-gradient(135deg, rgba(79,172,254,0.22), rgba(0,212,255,0.12)); border-color: rgba(79,172,254,0.22); color: var(--text); }
    .menu-btn.danger{ margin-top:auto; color: var(--danger); background: rgba(255,71,87,0.10); }

    .main { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; align-items: center; }
    .topbar{ width: 100%; display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px; }
    .user-pill{ display:flex; align-items:center; gap: 10px; padding: 10px 14px; border-radius: 99px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.10); }

    .scanner-box { width: 100%; max-width: 600px; background: var(--panel); border: 1px solid var(--border); border-radius: 24px; padding: 40px; margin-top: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.5); text-align: center; backdrop-filter: blur(12px); }
    .search-input { width: 100%; padding: 18px 20px 18px 55px; background: rgba(0,0,0,0.3); border: 2px solid var(--border); border-radius: 16px; color: #fff; font-size: 18px; outline: none; text-transform: uppercase; transition: 0.3s; }
    .search-input:focus { border-color: var(--primary); box-shadow: 0 0 25px rgba(79, 172, 254, 0.15); }
    
    .alert-error { background: rgba(255, 71, 87, 0.1); border: 1px solid var(--danger); color: var(--danger); padding: 20px; border-radius: 16px; margin-bottom: 20px; display: flex; flex-direction: column; align-items: center; gap: 10px; }
    .btn-create { background: var(--primary); color: #fff; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; text-decoration: none; display: flex; align-items: center; gap: 8px; }
    
    .product-header { background: linear-gradient(90deg, rgba(79,172,254,0.1), rgba(0,212,255,0.05)); border: 1px solid var(--primary); padding: 20px; border-radius: 16px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
    .stock-item { background: rgba(255,255,255,0.03); border: 1px solid var(--border); padding: 12px 15px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    
    .btn-save { width: 100%; padding: 14px; background: linear-gradient(135deg, var(--success), #23a356); color: #fff; font-weight: 700; border: none; border-radius: 10px; cursor: pointer; }
    .input-qty { width: 100%; padding: 12px; background: rgba(0,0,0,0.3); border: 1px solid var(--border); color: #fff; border-radius: 10px; text-align: center; font-size: 18px; font-weight: bold; outline: none; }

    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); display: none; justify-content: center; align-items: center; z-index: 100; }
    .modal-overlay.open { display: flex; }
    .modal-card { background: #131a28; border: 1px solid var(--border); width: 450px; padding: 30px; border-radius: 24px; box-shadow: 0 30px 60px rgba(0,0,0,0.7); }
    .input-text { width: 100%; padding: 12px; background: rgba(0,0,0,0.3); border: 1px solid var(--border); color: #fff; border-radius: 10px; outline: none; text-transform: uppercase; }
    
    /* ESTILOS PARA LOS SELECTS */
    select.input-text {
        appearance: none;
        background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%2300d4ff%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
        background-repeat: no-repeat;
        background-position: right .7em top 50%;
        background-size: .65em auto;
        cursor: pointer;
    }
    option { background-color: #131a28; color: #fff; }

    .btn-secondary { background: transparent; border: 1px solid var(--border); color: var(--muted); padding: 10px 20px; border-radius: 10px; cursor: pointer; }
  </style>
</head>
<body>
  <aside class="sidebar">
    <div class="brand"><img src="{% static 'inventario/img/logo.png' %}" alt="Logo"><h3>TELECABLE</h3></div>
    <nav class="menu">
      <a href="{% url 'dash_admin' %}" class="menu-btn"><i class='bx bxs-dashboard'></i> <span>Dashboard</span></a>
      <a href="{% url 'inventory_list' %}" class="menu-btn"><i class='bx bx-box'></i> <span>Inventario</span></a>
      <a href="#" class="menu-btn active"><i class='bx bx-barcode-reader'></i> <span>Escanear</span></a>
      <a href="/admin/" class="menu-btn"><i class='bx bxs-cog'></i> <span>Admin Django</span></a>
      <a href="{% url 'logout' %}" class="menu-btn danger"><i class='bx bx-log-out-circle'></i> <span>Salir</span></a>
    </nav>
  </aside>

  <main class="main">
    <header class="topbar"><div><h2>Módulo de Escaneo</h2><p style="color:var(--muted)">Sede: <b style="color:var(--primary)">{{ sede.nombre }}</b></p></div><div class="user-pill"><i class='bx bxs-user-circle'></i> <span>{{ user.username }}</span></div></header>
    
    <div class="scanner-box">
        <div style="font-size:48px; color:var(--primary); margin-bottom:15px;"><i class='bx bx-qr-scan'></i></div>
        <h2>Consultar y Agregar</h2>
        <p>Escanea un código. Si no existe, podrás crearlo.</p>

        <form method="GET" style="position: relative; margin-bottom: 30px;">
            <i class='bx bx-barcode' style="position: absolute; left: 20px; top: 18px; font-size: 24px; color: var(--muted);"></i>
            <input type="text" name="q" class="search-input uppercase-input" placeholder="Escanea aquí..." value="{{ q }}" autofocus autocomplete="off" onfocus="this.select()">
        </form>

        {% if error %}
        <div class="alert-error">
            <div><i class='bx bxs-error-circle'></i> {{ error }}</div>
            <button onclick="openCreateModal('{{ q }}')" class="btn-create"><i class='bx bx-plus-circle'></i> CREAR PRODUCTO</button>
        </div>
        {% endif %}

        {% if producto %}
        <div style="text-align: left; animation: fadeIn 0.4s ease;">
            
            <div class="product-header">
                <div>
                    <h3 style="margin:0;">{{ producto.nombre }}</h3>
                    <span style="font-family:monospace; color:var(--primary);">{{ producto.codigo_interno }}</span>
                </div>
                <div style="text-align:right;">
                    <small style="color:var(--muted)">CATEGORÍA</small><br>
                    <b>{{ producto.categoria.nombre|default:"General" }}</b>
                </div>
            </div>
            
            <div style="margin-bottom:20px;">
                <p style="font-size:12px; color:var(--muted);">DISPONIBILIDAD:</p>
                {% for st in stocks %}
                <div class="stock-item">
                    <span><i class='bx bxs-building-house' style="color:var(--primary)"></i> {{ st.sede.nombre }}</span>
                    <span style="font-size: 18px; font-weight: 700; color: var(--success);">{{ st.cantidad }}</span>
                </div>
                {% empty %}
                <div class="stock-item" style="justify-content:center; color:var(--muted);">Sin stock registrado.</div>
                {% endfor %}
            </div>

            <div style="background:rgba(0,0,0,0.2); padding:20px; border-radius:16px; border:1px solid var(--border);">
                <div style="display:flex; align-items:center; gap:8px; margin-bottom:15px;">
                    <i class='bx bx-plus-circle' style="color:#fff;"></i>
                    <span style="font-weight:600;">Ingreso Rápido</span>
                </div>
                
                <form action="{% url 'add_stock_simple' %}" method="POST">
                    {% csrf_token %}
                    <input type="hidden" name="origen" value="scan">
                    <input type="hidden" name="producto_id" value="{{ producto.id }}">
                    
                    <div style="margin-bottom: 12px;">
                        <label style="font-size:11px; color:var(--muted); margin-bottom:5px; display:block;">DESTINO</label>
                        <select name="target_sede_id" class="input-text" style="width:100%; cursor:pointer;">
                            {% for s in lista_sedes %}
                                <option value="{{ s.id }}" {% if s.id == sede.id %}selected{% endif %}>
                                    {{ s.nombre }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div style="display:flex; gap:10px; align-items: flex-end;">
                        <div style="width: 120px;">
                            <label style="font-size:11px; color:var(--muted); margin-bottom:5px; display:block;">CANTIDAD</label>
                            <input type="number" name="cantidad" class="input-qty" value="1" min="1" required>
                        </div>
                        <button type="submit" class="btn-save" style="margin-top:0; flex:1; height: 49px;">
                            <i class='bx bx-save'></i> GUARDAR
                        </button>
                    </div>
                </form>
            </div>
        </div>
        {% endif %}
    </div>
  </main>

  <div class="modal-overlay" id="createModal">
      <div class="modal-card">
          <h3 style="margin-bottom:20px;">Registrar Nuevo Producto</h3>
          
          <form action="{% url 'create_product_simple' %}" method="POST">
              {% csrf_token %}
              
              <div style="margin-bottom:15px;">
                  <label style="font-size:11px; color:var(--muted);">CÓDIGO DETECTADO</label>
                  <input type="text" name="codigo" id="newCode" class="input-text" readonly 
                         style="background:rgba(79, 172, 254, 0.1); color:var(--primary); border-color:var(--primary);">
              </div>

              <div style="margin-bottom:15px;">
                  <label style="font-size:11px; color:var(--muted);">NOMBRE DEL PRODUCTO</label>
                  <input type="text" name="nombre" class="input-text uppercase-input" required placeholder="EJ: CABLE UTP CAT6">
              </div>

              <div style="display:flex; gap:15px; margin-bottom:15px;">
                  <div style="flex:1;">
                      <label style="font-size:11px; color:var(--muted); margin-bottom:6px; display:block;">CATEGORÍA</label>
                      <select name="categoria_id" class="input-text uppercase-input" style="width:100%; cursor:pointer;" required>
                          <option value="" disabled selected>SELECCIONAR...</option>
                          {% for cat in lista_categorias %}
                              <option value="{{ cat.id }}">{{ cat.nombre }}</option>
                          {% empty %}
                              <option value="" disabled>Sin categorías</option>
                          {% endfor %}
                      </select>
                  </div>

                  <div style="flex:1;">
                      <label style="font-size:11px; color:var(--muted); margin-bottom:6px; display:block;">UNIDAD</label>
                      <select name="unidad_medida" class="input-text uppercase-input" style="width:100%;">
                          <option value="UNIDAD">UNIDAD</option>
                          <option value="METROS">METROS</option>
                          <option value="CAJAS">CAJAS</option>
                          <option value="KIT">KIT</option>
                          <option value="PIEZAS">PIEZAS</option>
                          <option value="BOBINAS">BOBINAS</option>
                      </select>
                  </div>
              </div>

              <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:10px; border:1px solid var(--border); margin-bottom:20px;">
                  <label style="font-size:11px; color:var(--primary); font-weight:bold; display:block; margin-bottom:10px;">
                      <i class='bx bxs-map'></i> UBICACIÓN INICIAL
                  </label>
                  
                  <div style="display:flex; gap:10px;">
                      <div style="flex:1;">
                          <label style="font-size:10px; color:var(--muted);">SEDE DE DESTINO</label>
                          <select name="target_sede_id" class="input-text" style="width:100%;">
                              {% for s in lista_sedes %}
                                  <option value="{{ s.id }}" {% if s.id == sede.id %}selected{% endif %}>
                                      {{ s.nombre }}
                                  </option>
                              {% endfor %}
                          </select>
                      </div>

                      <div style="width:100px;">
                          <label style="font-size:10px; color:var(--muted);">CANTIDAD</label>
                          <input type="number" name="cantidad" class="input-text" value="0" min="0" 
                                 style="text-align:center; font-weight:bold; color:var(--success);">
                      </div>
                  </div>
              </div>

              <div style="display:flex; gap:10px;">
                  <button type="button" class="btn-secondary" onclick="closeCreateModal()">Cancelar</button>
                  <button type="submit" class="btn-save" style="margin-top:0;">
                      <i class='bx bx-save'></i> GUARDAR
                  </button>
              </div>
          </form>
      </div>
  </div>

  <script>
      document.querySelectorAll('.uppercase-input').forEach(i => i.addEventListener('input', function() { this.value = this.value.toUpperCase(); }));
      function openCreateModal(code) { document.getElementById('newCode').value = code; document.getElementById('createModal').classList.add('open'); }
      function closeCreateModal() { document.getElementById('createModal').classList.remove('open'); }
  </script>
</body>
</html>