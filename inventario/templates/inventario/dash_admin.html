{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Admin Dashboard | Telecable</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    :root{ --bg: #0b0f1a; --bg2: #0f172a; --panel: rgba(255,255,255,0.06); --border: rgba(255,255,255,0.10); --text: rgba(255,255,255,0.92); --muted: rgba(255,255,255,0.62); --accent: #4facfe; --accent2: #00d4ff; --danger: #ff4757; --success: #2ed573; --radius: 18px; --shadow: 0 18px 45px rgba(0,0,0,0.45); }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: 'Poppins', sans-serif; background: radial-gradient(1000px 500px at 20% 0%, rgba(79,172,254,0.18), transparent 60%), radial-gradient(900px 450px at 90% 10%, rgba(0,212,255,0.12), transparent 60%), linear-gradient(180deg, var(--bg), var(--bg2)); color: var(--text); display:flex; height:100vh; overflow:hidden; }
    
    .sidebar { width: 270px; padding: 18px; background: rgba(255,255,255,0.04); border-right: 1px solid rgba(255,255,255,0.08); backdrop-filter: blur(12px); display:flex; flex-direction:column; gap: 10px; }
    .brand { display:flex; align-items:center; gap: 12px; padding: 12px; border-radius: 16px; background: rgba(255,255,255,0.05); margin-bottom: 8px; }
    .brand img { width: 44px; border-radius: 12px; background: rgba(255,255,255,0.08); padding: 6px; }
    .menu-btn { width: 100%; display:flex; align-items:center; gap: 12px; text-decoration:none; color: var(--muted); padding: 12px 14px; border-radius: 14px; transition: 0.2s; }
    .menu-btn:hover { background: rgba(255,255,255,0.06); color: var(--text); }
    .menu-btn.active { background: linear-gradient(135deg, rgba(79,172,254,0.22), rgba(0,212,255,0.12)); border-color: rgba(79,172,254,0.22); color: var(--text); }
    .menu-btn.danger { margin-top:auto; color: rgba(255,255,255,0.90); background: rgba(255,71,87,0.10); }

    .main { flex:1; padding: 26px; overflow-y:auto; }
    .topbar { display:flex; justify-content:space-between; align-items:center; margin-bottom: 18px; }
    .user-pill { display:flex; align-items:center; gap: 10px; padding: 10px 14px; border-radius: 999px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.10); }

    /* PESTAÑAS DINÁMICAS */
    .tabs-container { margin-bottom: 20px; display: flex; gap: 10px; }
    .tab-btn { padding: 10px 20px; border-radius: 12px; background: rgba(255,255,255,0.05); color: var(--muted); text-decoration: none; font-size: 13px; font-weight: 600; transition: 0.2s; border: 1px solid var(--border); }
    .tab-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }
    .tab-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3); }

    .grid { display:grid; grid-template-columns: repeat(12, 1fr); gap: 14px; margin-bottom: 14px; }
    .card { background: var(--panel); border: 1px solid var(--border); border-radius: var(--radius); padding: 18px; }
    
    .kpi { grid-column: span 3; min-height: 128px; display:flex; flex-direction:column; justify-content:space-between; }
    .kpi .icon { width: 44px; height: 44px; border-radius: 14px; display:flex; align-items:center; justify-content:center; background: rgba(255,255,255,0.06); }
    .kpi .icon i { font-size: 22px; }
    .kpi .value { font-size: 28px; font-weight: 800; }
    
    .kpi.actions { grid-column: span 3; display:flex; flex-direction:column; gap: 10px; }
    .btn-row { display:flex; flex-direction:column; gap: 10px; margin-top: 6px; }
    .btn { display:flex; align-items:center; justify-content:center; gap: 10px; padding: 12px 14px; border-radius: 14px; text-decoration:none; font-weight: 700; border: 1px solid rgba(255,255,255,0.12); color: #fff; }
    .btn.scan { background: linear-gradient(135deg, rgba(79,172,254,0.55), rgba(0,212,255,0.25)); }
    .btn.inv { background: rgba(255,255,255,0.06); }

    .content { display:grid; grid-template-columns: 7fr 5fr; gap: 14px; margin-top: 14px; }
    .chart-wrap { height: 320px; position: relative; }

    table { width:100%; border-collapse:collapse; }
    thead th { text-align:left; font-size: 11px; text-transform: uppercase; color: rgba(255,255,255,0.70); padding: 12px 10px; border-bottom: 1px solid rgba(255,255,255,0.10); }
    tbody td { padding: 12px 10px; border-bottom: 1px solid rgba(255,255,255,0.06); color: rgba(255,255,255,0.86); font-size: 13px; }
    .tag { display:inline-flex; align-items:center; gap: 4px; padding: 4px 8px; border-radius: 6px; font-weight: 700; font-size: 10px; }
    .tag.in { color: var(--success); background: rgba(46,213,115,0.1); }
    .tag.out { color: var(--danger); background: rgba(255,71,87,0.1); }
  </style>
</head>

<body>
  <aside class="sidebar">
    <div class="brand">
      <img src="{% static 'inventario/img/logo.png' %}" alt="Logo" onerror="this.src='https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRR2u00YQVbhLVgNlKIb0kFHTfj8QRLZSyrew&s'">
      <div class="title"><b>TELECABLE</b>
      <span>Admin·Almacén</span></div>
    </div>
    <nav class="menu">
      <a href="{% url 'dash_admin' %}" class="menu-btn active"><i class='bx bxs-dashboard'></i> <span>Dashboard</span></a>
      <a href="{% url 'inventory_list' %}" class="menu-btn"><i class='bx bx-box'></i> <span>Inventario</span></a>
      <a href="/admin/" class="menu-btn"><i class='bx bxs-cog'></i> <span>Admin Django</span></a>
      <a href="{% url 'logout' %}" class="menu-btn danger"><i class='bx bx-log-out-circle'></i> <span>Salir</span></a>
    </nav>
  </aside>

  <main class="main">
    <header class="topbar">
      <div><h2>Panel de Administración</h2><p>Sede operativa: <b style="color:white;">{{ sede.nombre }}</b></p></div>
      <div class="user-pill"><i class='bx bxs-user-circle'></i><span>{{ user.username }}</span></div>
    </header>

    <div class="tabs-container">
        {% for s in sedes %}
            <a href="?sede_id={{ s.id }}" class="tab-btn {% if s.id == sede.id %}active{% endif %}">
                {{ s.nombre }}
            </a>
        {% empty %}
            <a href="#" class="tab-btn active">{{ sede.nombre }}</a>
        {% endfor %}
    </div>

    <section class="grid">
      <div class="card kpi">
        <div class="icon"><i class='bx bxs-server' style="color: var(--accent2);"></i></div>
        <div style="margin-top:auto;"><span style="color:var(--muted); font-size:12px;">TOTAL EQUIPOS</span><div class="value">{{ total_equipos }}</div></div>
      </div>
      <div class="card kpi">
        <div class="icon"><i class='bx bx-git-commit' style="color: var(--accent);"></i></div>
        <div style="margin-top:auto;"><span style="color:var(--muted); font-size:12px;">METROS CABLE</span><div class="value">{{ total_cables }}</div></div>
      </div>
      <div class="card kpi">
        <div class="icon"><i class='bx bxs-alarm-exclamation' style="color: var(--danger);"></i></div>
        <div style="margin-top:auto;"><span style="color:var(--muted); font-size:12px;">STOCK BAJO</span><div class="value">{{ low_stock }}</div></div>
      </div>
      <div class="card kpi actions">
        <div style="color:var(--muted); font-size:12px;">ACCIONES RÁPIDAS</div>
        <div class="btn-row">
          <a class="btn scan" href="{% url 'scan' %}"><i class='bx bx-scan'></i> Escanear</a>
          <a class="btn inv" href="{% url 'inventory_list' %}"><i class='bx bx-list-ul'></i> Ver inventario</a>
        </div>
      </div>
    </section>

    <section class="content">
      <div class="card">
        <h4 style="margin-bottom:15px;">Distribución</h4>
        <div class="chart-wrap"><canvas id="inventoryChart"></canvas></div>
      </div>

      <div class="card">
        <h4 style="margin-bottom:15px;">Últimos movimientos ({{ sede.nombre }})</h4>
        <table>
          <thead>
            <tr>
              <th>Producto</th>
              <th>Sede</th>
              <th>Tipo</th>
              <th>Cant.</th>
            </tr>
          </thead>
          <tbody>
            {% for mov in ult_movs %}
              <tr>
                <td style="font-weight:600;">{{ mov.producto.nombre }}</td>
                <td style="color:var(--accent2); font-size:12px;">{{ mov.sede.nombre }}</td>
                <td>
                  {% if mov.tipo_movimiento == 'ENTRADA' %}
                    <span class="tag in"><i class='bx bx-up-arrow-alt'></i> IN</span>
                  {% else %}
                    <span class="tag out"><i class='bx bx-down-arrow-alt'></i> OUT</span>
                  {% endif %}
                </td>
                <td>{{ mov.cantidad }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="4" style="text-align:center; padding:20px; color:var(--muted);">Sin movimientos recientes</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>

    {{ total_equipos|default:0|json_script:"totalEquipos" }}
    {{ total_cables|default:0|json_script:"totalCables" }}
    {{ low_stock|default:0|json_script:"lowStock" }}

    <script>
        const totalEquipos = JSON.parse(document.getElementById('totalEquipos').textContent);
        const totalCables = JSON.parse(document.getElementById('totalCables').textContent);
        const lowStock = JSON.parse(document.getElementById('lowStock').textContent);
        const ctx = document.getElementById('inventoryChart').getContext('2d');
        new Chart(ctx, {
            type: 'doughnut',
            data: {
            labels: ['Total equipos', 'Metros cable', 'Stock bajo'],
            datasets: [{
                data: [totalEquipos, totalCables, lowStock],
                backgroundColor: ['rgba(0,212,255,0.7)', 'rgba(0,102,204,0.7)', 'rgba(255,71,87,0.7)'],
                borderWidth: 0
            }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#a0a0a0' } } } }
        });

        // ALERTA DE ACCESO DENEGADO SI EL BACKEND LO ENVÍA
        {% if messages %}
            {% for message in messages %}
                {% if message.tags == 'error' %}
                    Swal.fire({
                        icon: 'error',
                        title: 'Acceso Denegado',
                        text: '{{ message }}',
                        background: '#131a28',
                        color: '#fff',
                        confirmButtonColor: '#4facfe'
                    });
                {% endif %}
            {% endfor %}
        {% endif %}
    </script>
  </main>
</body>
</html>