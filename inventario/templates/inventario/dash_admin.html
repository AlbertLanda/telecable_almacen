{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Gerencia | Telecable</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg: #0b0f1a;
      --bg2: #0f172a;
      --panel: rgba(255,255,255,0.06);
      --border: rgba(255,255,255,0.10);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.62);

      --accent: #4facfe;
      --accent2: #00d4ff;
      --danger: #ff4757;
      --success: #2ed573;
      --warning: #f6c23e;

      --radius: 18px;
      --shadow: 0 18px 45px rgba(0,0,0,0.45);
    }

    * { margin:0; padding:0; box-sizing:border-box; }

    body {
      font-family: 'Poppins', sans-serif;
      background:
        radial-gradient(1000px 500px at 20% 0%, rgba(79,172,254,0.18), transparent 60%),
        radial-gradient(900px 450px at 90% 10%, rgba(0,212,255,0.12), transparent 60%),
        radial-gradient(900px 500px at 50% 100%, rgba(255,71,87,0.10), transparent 60%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      color: var(--text);
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    /* --- SIDEBAR --- */
    .sidebar {
      width: 270px;
      padding: 18px;
      background: rgba(255,255,255,0.04);
      border-right: 1px solid rgba(255,255,255,0.08);
      backdrop-filter: blur(12px);
      display: flex;
      flex-direction: column;
      gap: 10px;
      box-shadow: 10px 0 45px rgba(0,0,0,0.25);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border-radius: 16px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.08);
      margin-bottom: 8px;
    }

    .brand img {
      width: 44px; height: 44px;
      border-radius: 12px;
      object-fit: contain;
      background: rgba(255,255,255,0.08);
      padding: 6px;
    }

    .brand .title { display: flex; flex-direction: column; line-height: 1.1; }
    .brand .title b { letter-spacing: .6px; }
    .brand .title span { font-size: 12px; color: var(--muted); }

    .menu { display: flex; flex-direction: column; gap: 8px; margin-top: 6px; }

    .menu-btn {
      width: 100%;
      display: flex; align-items: center; gap: 12px;
      text-decoration: none;
      color: var(--muted);
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid transparent;
      transition: all .2s ease;
    }
    .menu-btn i { font-size: 20px; }
    .menu-btn:hover {
      background: rgba(255,255,255,0.06);
      border-color: rgba(255,255,255,0.08);
      color: var(--text);
      transform: translateX(5px);
    }
    .menu-btn.active {
      background: linear-gradient(135deg, rgba(79,172,254,0.22), rgba(0,212,255,0.12));
      border-color: rgba(79,172,254,0.22);
      color: var(--text);
    }
    .menu-btn.danger {
      margin-top: auto;
      color: #ffbdc3;
      background: rgba(255,71,87,0.10);
      border: 1px solid rgba(255,71,87,0.20);
    }
    .menu-btn.danger:hover { background: rgba(255,71,87,0.16); }

    /* --- MAIN --- */
    .main { flex: 1; padding: 26px; overflow-y: auto; }

    .topbar {
      display: flex; justify-content: space-between; align-items: flex-start;
      gap: 12px; flex-wrap: wrap; margin-bottom: 18px;
    }
    .topbar h2 { font-size: 26px; font-weight: 700; }
    .topbar p { color: var(--muted); margin-top: 4px; font-size: 13px; }

    .user-pill {
      display: flex; align-items: center; gap: 10px;
      padding: 10px 14px; border-radius: 999px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      backdrop-filter: blur(10px);
    }
    .user-pill i { font-size: 20px; color: var(--accent2); }

    /* FORMULARIOS Y SELECTS */
    .sede-form { margin-top: 10px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    .select {
      padding: 10px 12px; border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.90);
      outline: none;
    }
    .select option { color: #111; }
    .btn-mini {
      padding: 10px 12px; border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.08);
      color: rgba(255,255,255,0.92);
      cursor: pointer; font-weight: 700;
    }
    .btn-mini:hover { filter: brightness(1.1); }

    /* GRID & CARDS */
    .grid {
      display: grid; grid-template-columns: repeat(12, 1fr);
      gap: 14px; margin-bottom: 14px;
    }
    .card {
      background: var(--panel); border: 1px solid var(--border);
      border-radius: var(--radius); box-shadow: var(--shadow);
      padding: 18px; backdrop-filter: blur(12px);
    }

    .kpi {
      grid-column: span 3; min-height: 128px;
      display: flex; flex-direction: column; justify-content: space-between;
    }
    .kpi .icon {
      width: 44px; height: 44px; border-radius: 14px;
      display: flex; align-items: center; justify-content: center;
      background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.08);
    }
    .kpi .icon i { font-size: 22px; }
    .kpi .value { font-size: 28px; font-weight: 800; }

    .kpi.actions {
      grid-column: span 3;
      display: flex; flex-direction: column; gap: 10px;
    }

    /* BOTONES DE ACCI√ìN */
    .btn-row { display: flex; flex-direction: column; gap: 8px; margin-top: 6px; }
    .btn {
      display: flex; align-items: center; justify-content: center;
      gap: 10px; padding: 10px 14px; border-radius: 12px;
      text-decoration: none; font-weight: 700; font-size: 13px;
      border: 1px solid rgba(255,255,255,0.12);
      transition: all .2s ease;
    }
    .btn:hover { transform: translateY(-2px); }
    
    .btn.scan {
      background: linear-gradient(135deg, rgba(79,172,254,0.55), rgba(0,212,255,0.25));
      color: white; border-color: rgba(79,172,254,0.30);
    }
    
    /* ü§ë BOT√ìN NUEVO: FINANCIERO */
    .btn.money {
        background: linear-gradient(135deg, #1cc88a 0%, #13855c 100%);
        color: white; border-color: #1cc88a;
        box-shadow: 0 4px 15px rgba(28, 200, 138, 0.3);
    }
    .btn.money:hover { box-shadow: 0 6px 20px rgba(28, 200, 138, 0.5); }

    .btn.inv {
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.90);
    }

    /* CONTENIDO */
    .content {
      display: grid; grid-template-columns: 7fr 5fr;
      gap: 14px; margin-top: 14px;
    }
    .chart-wrap { height: 320px; position: relative; }

    /* TABLA */
    table { width: 100%; border-collapse: collapse; overflow: hidden; border-radius: 14px; }
    thead th {
      text-align: left; font-size: 11px; text-transform: uppercase;
      color: rgba(255,255,255,0.70); padding: 12px 10px;
      border-bottom: 1px solid rgba(255,255,255,0.10);
    }
    tbody td {
      padding: 12px 10px; border-bottom: 1px solid rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.86); font-size: 13px;
    }
    .tag {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 4px 8px; border-radius: 999px; font-weight: 800; font-size: 10px;
      border: 1px solid rgba(255,255,255,0.10);
    }
    .tag.in { color: var(--success); background: rgba(46,213,115,0.15); border-color: rgba(46,213,115,0.25); }
    .tag.out { color: var(--danger); background: rgba(255,71,87,0.15); border-color: rgba(255,71,87,0.25); }
    .tag.adj { color: #ffd36b; background: rgba(255,211,107,0.15); border-color: rgba(255,211,107,0.25); }

    /* RESPONSIVE */
    @media (max-width: 1100px) { .kpi, .kpi.actions { grid-column: span 6; } .content { grid-template-columns: 1fr; } }
    @media (max-width: 900px) {
      body { overflow: auto; height: auto; flex-direction: column; }
      .sidebar { width: 100%; position: relative; flex-direction: row; justify-content: space-between; align-items: center; }
      .menu { flex-direction: row; flex-wrap: wrap; margin-top: 0; }
      .brand .title span { display: none; }
      .menu-btn span { display: none; }
    }
  </style>
</head>

<body>
  <aside class="sidebar">
    <div class="brand">
      <img src="{% static 'inventario/img/logo.png' %}" alt="TC"
           onerror="this.src='https://cdn-icons-png.flaticon.com/512/906/906343.png'">
      <div class="title">
        <b>TELECABLE</b>
        <span>Gerencia</span>
      </div>
    </div>

    <nav class="menu">
      <a href="{% url 'dash_admin' %}" class="menu-btn active">
        <i class='bx bxs-dashboard'></i> <span>Dashboard</span>
      </a>
      
      <a href="{% url 'admin_reporte_lista' %}" class="menu-btn">
        <i class='bx bx-line-chart'></i> <span>Reporte Financiero</span>
      </a>

      <a href="{% url 'inventory_list' %}" class="menu-btn">
        <i class='bx bx-box'></i> <span>Inventario Global</span>
      </a>

      <a href="{% url 'scan' %}" class="menu-btn">
        <i class='bx bx-barcode-reader'></i> <span>Escanear</span>
      </a>

      <a href="/admin/" class="menu-btn" target="_blank">
        <i class='bx bxs-cog'></i> <span>Admin Django</span>
      </a>

      <a href="{% url 'logout' %}" class="menu-btn danger">
        <i class='bx bx-log-out-circle'></i> <span>Cerrar Sesi√≥n</span>
      </a>
    </nav>
  </aside>

  <main class="main">
    <header class="topbar">
      <div>
        <h2>Panel Gerencial</h2>
        <p>
          Vista global de operaciones: <b style="color:#fff;">{{ sede.nombre }}</b>
        </p>

        {% if sedes %}
          <form class="sede-form" method="get" action="{% url 'dash_admin' %}">
            <select class="select" name="sede_id">
              {% for s in sedes %}
                <option value="{{ s.id }}" {% if sede and s.id == sede.id %}selected{% endif %}>
                  {{ s.nombre }}
                </option>
              {% endfor %}
            </select>
            <button class="btn-mini" type="submit">Filtrar</button>
          </form>
        {% endif %}

        {% if messages %}
          <div style="margin-top:10px;">
          {% for message in messages %}
            <span class="tag" style="background: #4facfe; color:white;">{{ message }}</span>
          {% endfor %}
          </div>
        {% endif %}
      </div>

      <div class="user-pill">
        <i class='bx bxs-user-circle'></i>
        <span>{{ user.username }}</span>
      </div>
    </header>

    <section class="grid">
      <div class="card kpi">
        <div class="icon"><i class='bx bxs-server' style="color: var(--accent2);"></i></div>
        <div class="label">Total Equipos</div>
        <div class="value">{{ total_equipos }}</div>
      </div>

      <div class="card kpi">
        <div class="icon"><i class='bx bx-git-commit' style="color: var(--accent);"></i></div>
        <div class="label">Cableado (m)</div>
        <div class="value">{{ total_cables }}</div>
      </div>

      <div class="card kpi">
        <div class="icon"><i class='bx bxs-alarm-exclamation' style="color: var(--danger);"></i></div>
        <div class="label">Stock Cr√≠tico</div>
        <div class="value">{{ low_stock }}</div>
      </div>

      <div class="card kpi actions">
        <div>
          <div class="label" style="margin-bottom:6px;">Acciones Gerenciales</div>
          <div style="color: var(--muted); font-size: 13px;">Control y Auditor√≠a</div>
        </div>
        <div class="btn-row">
            <a class="btn money" href="{% url 'admin_reporte_lista' %}">
                <i class='bx bx-dollar-circle fs-5'></i> Reportes Financieros
            </a>
            
            <a class="btn inv" href="{% url 'inventory_list' %}">
                <i class='bx bx-list-ul'></i> Inventario Completo
            </a>
        </div>
      </div>
    </section>

    <section class="content">
      <div class="card">
        <h4>Distribuci√≥n de Stock</h4>
        <div class="chart-wrap">
          <canvas id="inventoryChart"></canvas>
        </div>
      </div>

      <div class="card">
        <h4>√öltimos Movimientos</h4>
        <table>
          <thead>
            <tr>
              <th>Producto</th>
              <th>Movimiento</th>
              <th>Cant.</th>
            </tr>
          </thead>
          <tbody>
            {% for mov in ult_movs %}
              <tr>
                <td>{{ mov.producto.nombre }}</td>
                <td>
                  {% if mov.tipo == 'IN' %}
                    <span class="tag in"><i class='bx bx-up-arrow-alt'></i> IN</span>
                  {% elif mov.tipo == 'OUT' %}
                    <span class="tag out"><i class='bx bx-down-arrow-alt'></i> OUT</span>
                  {% else %}
                    <span class="tag adj"><i class='bx bx-transfer-alt'></i> ADJ</span>
                  {% endif %}
                </td>
                <td style="font-weight:bold;">{{ mov.qty }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="3" style="text-align:center; padding:20px;">Sin datos recientes</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>

    {{ total_equipos|default:0|json_script:"totalEquipos" }}
    {{ total_cables|default:0|json_script:"totalCables" }}
    {{ low_stock|default:0|json_script:"lowStock" }}

    <script>
      const totalEquipos = JSON.parse(document.getElementById('totalEquipos').textContent);
      const totalCables = JSON.parse(document.getElementById('totalCables').textContent);
      const lowStock = JSON.parse(document.getElementById('lowStock').textContent);

      const ctx = document.getElementById('inventoryChart').getContext('2d');
      new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Equipos', 'Cables (m)', 'Cr√≠ticos'],
          datasets: [{
            data: [totalEquipos, totalCables, lowStock],
            backgroundColor: [
              'rgba(0,212,255,0.7)',
              'rgba(0,102,204,0.7)',
              'rgba(255,71,87,0.7)'
            ],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
              legend: { position: 'bottom', labels: { color: 'white' } }
          }
        }
      });
    </script>
  </main>
</body>
</html>